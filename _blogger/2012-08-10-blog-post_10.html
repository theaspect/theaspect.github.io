---
layout: post
title: Больше тестирования
date: '2012-08-11T02:02:00.003+07:00'
author: Constantine Linnick
tags:
- тестирование
- development
modified_time: '2014-04-10T15:46:23.670+07:00'
thumbnail: http://1.bp.blogspot.com/-cwzyVUk_qqM/UB_P_EyARII/AAAAAAAABg8/sM7PDLUho6U/s72-c/%D0%9A%D0%BE%D0%BC%D0%B8%D0%BA%D1%81.png
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-7710383052929415680
blogger_orig_url: http://blog.blzr.me/2012/08/blog-post_10.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div dir="ltr" style="text-align: left;" trbidi="on"><div class="" style="clear: both; text-align: justify;"></div><div style="text-align: right;"></div><a href="http://1.bp.blogspot.com/-cwzyVUk_qqM/UB_P_EyARII/AAAAAAAABg8/sM7PDLUho6U/s1600/%D0%9A%D0%BE%D0%BC%D0%B8%D0%BA%D1%81.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="200" src="http://1.bp.blogspot.com/-cwzyVUk_qqM/UB_P_EyARII/AAAAAAAABg8/sM7PDLUho6U/s200/%D0%9A%D0%BE%D0%BC%D0%B8%D0%BA%D1%81.png" width="95" /></a>Суть статей про Юнит-тестирование:<br /><br />В правильных тестах <a href="http://www.javaranch.com/unit-testing.jsp">не должно быть</a> [1]<br /><ul style="text-align: left;"><li>ввода-вывода</li><li>обращения к ресурсам</li><li>доступа к базе&nbsp;</li><li>доступа к другим приложениям </li></ul>Печально, что все этим же и заканчивается: если вы не можете протестировать ваш класс, то, скорее всего, он неправильно спроектирован. Для сложных случаев придется использовать магию моков, стабов и фикстур.<br /><br /><a name='more'></a><br /><h2 style="text-align: left;">Классная работа </h2>Рассмотрим пример:<br /><br /><pre class="brush:java">package com.blazer.testing;<br /><br />public class Divider {<br />&nbsp;&nbsp;&nbsp; private float dividend;<br /><br />&nbsp;&nbsp;&nbsp; public Divider(float value) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.dividend = value;<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; public float divide(float divisor) throws DivisionByZeroException {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (divisor == 0) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new DivisionByZeroException();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return dividend / divisor;<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; public static class DivisionByZeroException extends Exception {<br />&nbsp;&nbsp;&nbsp; }<br />}<br /></pre><br />Покрываем его тестами:<br /><br /><pre class="brush:java">package com.blazer.testing;<br /><br />import org.junit.Test;<br /><br />import static junit.framework.Assert.assertEquals;<br /><br />public class DividerTest {<br />    @Test<br />    public void testDivision() throws Divider.DivisionByZeroException {<br />        Divider divider = new Divider(5f);<br />        assertEquals(2.5f, divider.divide(2f));<br />    }<br /><br />    @Test<br />    public void testZeroDividend() throws Divider.DivisionByZeroException {<br />        Divider divider = new Divider(0f);<br />        assertEquals(0f, divider.divide(5f));<br />    }<br /><br />    @Test(expected = Divider.DivisionByZeroException.class)<br />    public void testDivisionByZero() throws Divider.DivisionByZeroException {<br />        Divider divider = new Divider(5f);<br />        divider.divide(0f);<br />    }<br />}<br /></pre><br />Не правда ли тестирование это просто?<br /><h2 style="text-align: left;">Домашнее задание&nbsp; </h2>Покройте тестами ваше реальное приложение. В приложении имеется пол-дюжины взаимосвязанных компонентов, доступ к СУБД, файловой системе и написано оно в процедурном стиле.<br /><br />Мне лень было писать процедурный код, поэтому просто опишу "реальное приложение" словами:<br /><ul style="text-align: left;"><li>приложение ищет в папке, полученной как параметр, файлы</li><li>имена файлов должны состоять исключительно из цифр</li><li>берется файл с самым наибольшим числом и парсится</li><li>файл - два столбца разделенных пробелом: строка и число</li><li>все неправильные строки игнорируются</li><li>все правильные строки "анти-апсертятся" в базу (найденные ключи удаляются, новые добавляются)</li></ul><h4 style="text-align: left;">Тестируемость </h4>Первое что приходится делать для тестирования - жестоко дробить код: первое что приходит на ум - вынести парсер и <a href="https://bitbucket.org/theaspect/sandbox/src/default/src/test/java/com/blazer/homework/ParserTest.java">протестировать</a>. Тесты пишутся за пять минут.И тут ступор: что делать дальше, как тестировать остальные 90% кода непонятно [2].</div><div dir="ltr" style="text-align: left;" trbidi="on"><br />Ответ прост не боятся дробить и нарушать инкапсуляцию (в разумных пределах): как сказал автор статьи "доллар за нарушение красоты ОО подхода окупится двадцаткой в тестируемости".</div><div dir="ltr" style="text-align: left;" trbidi="on"><h4 style="text-align: left;">Стабы и моки</h4><div style="text-align: left;">Имитируем поведение другого объекта, возвращая на изначально заданные вопросы нужные ответы. Позволяет <a href="https://bitbucket.org/theaspect/sandbox/src/src/test/java/com/blazer/homework/FileSelectorTest.java">протестировать</a> работу с файловой системой. Есть ограничение: в общем случае подменяются только публичные методы.</div><div style="text-align: left;"><br /></div><pre class="brush:java">@Test<br /><br />public void correctWithPadding() throws FileNotFoundException {<br />    File file = mock(File.class);<br />    when(file.isDirectory()).thenReturn(true);<br />    when(file.list()).thenReturn(new String[]{"abc", "0321", "0123", "asd"});<br /><br />    assertEquals("0321", new FileSelector(file).getMaxFile());<br />}<br /></pre><div style="text-align: left;"><br />Иногда хочется протестировать большой внутренний метод. Для этого видится два решения: либо делать метод публичным (нарушение инкапсуляции), либо передавать в класс стратегию (класс с единственным методом).</div><h4 style="text-align: left;">Фикстуры</h4><div style="text-align: left;">Главный затык в этом месте: как создать тестовую среду, на которой можно поработать с базой. Как оказалось, все упиралось в инструменты: с maven и hibernate/migrations можно не напрягаясь подменить рабочую базу маленькой СУБД создаваемой в памяти, как правило, для одной транзакции (в особых случаях коммитить изменения таки приходится). Как только это препятствие было убрано, тестировать работу с базой стало легко и просто.</div><br /><pre class="brush:java">@Before<br />public void initDB() throws SQLException, IOException {<br />    connection = DriverManager.getConnection(CONNECTION_STRING, "SA", "");<br />    connection.prepareStatement(INIT_TABLE).execute();<br />    loadFixtures(connection, "com/blazer/homework/fixtures.sql");<br />}<br /><br />@After<br />public void dropDB() throws SQLException, IOException {<br />    connection.rollback();<br />    Closer.close(connection);<br />}<br /><br />@Test<br />public void testGetData() throws SQLException {<br />    Dao dao = new Dao(connection);<br />    Assert.assertEquals(new HashSet<domain>() {{ "{{" }}<br />        add(new Domain("qwer", 123L));<br />        add(new Domain("asdf", 456L));<br />        add(new Domain("zxcv", 789L));<br />    }}, dao.getData());<br />}<br /></domain></pre><br /><div style="text-align: left;"><h4 style="text-align: left;">Продолжение следует</h4><div style="text-align: left;">Дальше предстоит разобраться как тестировать пользовательский интерфейс. Здесь все опять упирается в инструментарий: VAADIN генерирует одноразовую и абсолютно нетестируемую разметку. Они даже написали платную тулзу поверх Selenium. При тестировании отображения - смена дизайна поломает все тесты, а тестируя только презентеры в MVP - не протестируем то, что рендерится браузером.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Еще одним переходным этапом может стать использование DI в коде, что резко понизит связанность между модулями и повысит тестируемость кода.</div><div style="text-align: left;"><br /></div></div></div><div dir="ltr" style="text-align: left;" trbidi="on"></div><div dir="ltr" style="text-align: left;" trbidi="on"><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-yzirSUVLlKg/UCVJbcOBf3I/AAAAAAAABhQ/U5mKJDLmTe4/s1600/coverage.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="142" src="http://3.bp.blogspot.com/-yzirSUVLlKg/UCVJbcOBf3I/AAAAAAAABhQ/U5mKJDLmTe4/s320/coverage.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Превосходный результат</td><td class="tr-caption" style="text-align: center;"><br /></td><td class="tr-caption" style="text-align: center;"><br /></td><td class="tr-caption" style="text-align: center;"><br /></td></tr></tbody></table><br />[1] Отличная статья, кстати. Жаль, что я её прочитал после написания кода <br />[2] Застрял на этом этапе <a href="http://code.google.com/p/sdast/source/browse/trunk/couch/test/model/Templates.java">на два года</a></div></div>