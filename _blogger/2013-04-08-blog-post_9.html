---
layout: post
title: Код с привидениями
date: '2013-04-09T02:39:00.003+07:00'
author: Constantine Linnick
tags:
- боль
- тестирование
- development
modified_time: '2014-04-10T15:47:19.663+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-452375325019896451
blogger_orig_url: http://blog.blzr.me/2013/04/blog-post_9.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Есть в коде места, заросшие паутиной, куда разработчики редко заглядывают. При этом, такие места иногда напоминают о себе в самых неожиданных местах.<br /><a name='more'></a><br />Когда мы активно готовились к <a href="http://blog.blzr.me/2013/03/cebit.html">выставке</a> и тестировали систему, Hibernate начал бросать странное исключение <i>collection [] was not processed by flush() triggering for unknown reasons</i> с пометкой <i>this may indicate a bug in Hibernate, but is more likely due to unsafe use of the session</i>. Гуглинг сразу вывел на закрытые тикет <a href="https://hibernate.atlassian.net/browse/HHH-3876">HHH-3876</a>, который тоже не сильно помог. В данном сущности была парочка мутабельных коллекций, которые лениво подгружались. Стоило поставить жадную подгрузку, как исключение пропадало. Тут взгляд упал на строку:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">@EqualsAndHashCode(exclude = {"tags"})</span><br /><br />которая подменяла стандартные методы equals и hashCode. Эта аннотация принадлежит великолепной библиотеке <a href="http://projectlombok.org/">lombok</a>, позволяющей при компиляции генерировать boilerplate код: toString, getter, setter, equalsAndHashCode.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://s3.developerslife.ru/public/images/gifs/b59d9aa2-f010-46ce-98ca-0f195139f3e4.gif" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://s3.developerslife.ru/public/images/gifs/b59d9aa2-f010-46ce-98ca-0f195139f3e4.gif" height="192" width="320" /></a></div>Тем не менее, подменять хэшкод в мутабельных классах - очень плохая идея, ведущая к крайне веселым последствиям. Как оказалось, при персисте, гибернейт дергал метод equals, тот в свою очередь пробегался по полям и задевал ленивый прокси, прокси инициализировался и изменял хэш объекта, гибернейт видел это и сходил с ума от внезапного изменения уже обработанной коллекции.<br /><br />На фикс бага ушло несколько часов. Самое веселое началось, когда мы открыли историю:<br /><br /><table><tbody><tr><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">2013-02-19</span></td><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Удалено</span></td></tr><tr><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">2012-11-28</span></td><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">@EqualsAndHashCode(exclude = {"tags"})</span></td></tr><tr><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">2012-10-14</span></td><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">@EqualsAndHashCode(exclude = {"users"})</span></td></tr><tr><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">2012-10-12</span></td><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">@EqualsAndHashCode(exclude = {"users", "tags"})</span></td></tr><tr><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">2012-05-25</span></td><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">@EqualsAndHashCode(exclude = {"users"})</span></td></tr><tr><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">2012-05-03</span></td><td><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">@EqualsAndHashCode)</span></td></tr></tbody></table><br />А теперь, самое интересное, результаты <a href="http://blog.blzr.me/2012/10/blog-post_13.html">раскопок</a>: добавлен этот метод был для удобства <a href="http://blog.blzr.me/2013/03/blog-post_28.html">тестирования</a>. На тот момент, сущность не содержала коллекций и результаты тестов было очень удобно сравнивать с ожидаемыми объектами. Но спустя некоторое время, объект стал сложным и сравнение было переписано на toString, необходимость в подмене equals отпала. Тем не менее equals жил еще несколько месяцев, порождая трудноуловимые баги. А сколько еще таких привидений живет в коде?</div>