---
layout: post
title: Версионирование схемы БД
date: '2013-04-21T21:32:00.001+07:00'
author: Constantine Linnick
tags:
- боль
- open source
- контроль версий
- development
modified_time: '2014-04-10T15:47:19.631+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-1844550468787087561
blogger_orig_url: http://blog.blzr.me/2013/04/blog-post_21.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><h4 style="text-align: left;"><a href="http://s3.developerslife.ru/public/images/gifs/841b3185-92b7-4515-af6b-5506606e052e.gif" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://s3.developerslife.ru/public/images/gifs/841b3185-92b7-4515-af6b-5506606e052e.gif" height="179" width="320" /></a>1 часть. Ораклява </h4>Как-то меня перекинули на мой первый серьезный проект. Главная проблема была в том, что из проекта ушел основной разработчик, проект оказался в середине большого переписывания, а мне знания передавались неспециалистом в формате вуду-практик. Этих плясок было достаточно, чтобы поддерживать хоть какое-то подобие жизни.<br /><br /><a name='more'></a><br /><br />Оправившись от шока и расчистив <a href="http://forum.ixbt.com/topic.cgi?id=26:40847:18#18">эпсилон-окрестность</a>, стало легче дышать и уже можно было подумать о переписывании отдельных кусков. К тому моменту у нас уже была система <a href="http://blog.blzr.me/2013/04/blog-post.html">контроля версий</a>. Большая часть бизнес-логики хранилась в Oracle, разухабистые пакеты с большими портянками селектов. Меньшая часть запросов (тоже здоровые портянки) хранилась прямо в коде. [Проблемам хранения бизнес-логики в БД посвящен <a href="http://blog.blzr.me/2013/04/blog-post_24.html">отдельный</a> псто, полный боли и страданий.] А вот это-как раз сильно напрягало: в случае проблем с запросом, нужно его скопировать из эклипса, вставить в скуль девелопер, убрать все кавычки, заменить JDBC-шные двоеточия на амперсанды, а внести изменения и повторить в обратном порядке - весь этот процесс дичайше накалял. Да и вообще здоровенные запросы сильно мешали чтению кода. И почему в java нет многострочных строк, как в питоне?<br /><br />Первая попытка была - вынести все запросы в XML файл, обрамить их в , дать им имена и подгружать запросы в коде. После первой же попытки пришлось дополнительно обрамить их в <span style="font-family: inherit;"></span><code><span style="font-family: inherit;">&lt;![CDATA[]]&gt;</span></code>. DBA вздохнул с облегением,&nbsp; но размазанность кода между двумя системами сильно напрягала.<br /><br />Когда мы узнали про <a href="http://docs.oracle.com/cd/B19306_01/appdev.102/b14289/dcitblfns.htm">REF CURSOR</a>, то быстро отказались от файлика с запросами и наконец-то перенесли все запросы в одно место - БД, рассовав их по пакетам. Приложение полностью диссоциировало на две независимые сущности: запросы, сложнее <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SELECT * FROM</span> и схема в ведении DBA, всё остальное - принадлежит разработчикам.<br /><br />Все бы ничего, если бы не один эпизод. Мы враппили все пакеты в целях секурности и однажды завраппили рабочую базу с последними изменениями. Несколько часов паники и отчаяния, пока мы не нашли <a href="http://www.codecrete.net/UnwrapIt">unwrap</a>. Сразу после этого отчаянно захотелось версионировать схему, которая содержала критически важный код.<br /><br />Старый добрый <a href="http://docs.oracle.com/cd/E11882_01/server.112/e22490/original_export.htm#BABBHCIE">exp</a> позволяет экспортировать схему без сжатия и данных, что позволяет видеть диффы между версиями. Мы быстро прикрутили Ant-таск, который перед коммитом экспортировал схему. Все было великолепно, до второго коммита, который показал дифф. Одна строка реальных изменений привела к разнице во всех до единой строках экспорта, которыйх просто херил все переносы строк и переносил строки в районе 80-й колонки. Попытки выставить бесконечную, или просто разумно большую ширину буфера не привели абсолютно ни к какому эффекту.<br /><br />Я отчаялся и начал искать решение. Схему можно было получить вручную выполнив запросы из командной строки, но sqlplus плевать хотел на задаваемую ширину буфера и результат не отличался от того, что давал exp. Но случилось чудо: JDBC оказался более сговорчивым и отдавал схему as-is не расставляя переносы, как ему вздумается. Я быстро накидал плагин для ant (который потом передеал на простую командную строку) и <a href="https://github.com/theaspect/antor">выложил</a> на GitHub - первый и последний рабочий проект на git.<br /><h4 style="text-align: left;"><a href="http://themetapicture.com/media/funny-gif-bad-taste-tongue-out.gif" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://themetapicture.com/media/funny-gif-bad-taste-tongue-out.gif" /></a><a href="http://xkcd.ru/353/" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://xkcd.ru/i/353_v1.png" height="400" width="351" /></a>2 Часть. Пайсон</h4>На новой работе, попробовав написать на <a href="http://yiiframework.com/">PHP</a>, я быстро отказался в пользу <a href="https://www.djangoproject.com/">Django</a>. Это был дивный новый мир, где был человеческий ORM и не нужно было руками переносить данные из курсоров в доменные объекты. Я просто забыл про написание CRUD-запросов, которые составляли 95%. И никакой логики с базе: рабочая база накатывается с нуля одной командой; никакого оракла: работать можно с любой базой, на любой машине, хоть с sqlite (который идет с питоном), если лень ставить мускуль или постгрес. После монструозности оракла, я парил.<br /><br />Когда появились реальные данные и я задумался, как накатывать схему (стандартный механизм весьма примитивен), под рукой оказался <a href="http://south.aeracode.org/">South</a>, который ставился в одну строку, САМ искал отличия в схеме, позволял мигрировать в обе стороны (конечно, учитывая потери данных), и пытался откатить схему к стабильному состоянию в случае ошибки. Это была просто сказка. Кстати, когда <a href="https://www.djangoproject.com/weblog/2013/mar/22/kickstarting-schema-migrations-django/">объявили</a> сбор средств на кикстартере для интеграции South в Django, деньги нашлись мгновенно, причем насобирали в <a href="http://www.kickstarter.com/projects/andrewgodwin/schema-migrations-for-django">7 РАЗ</a> больше необходимого.<br /><h4 style="text-align: left;">3 часть. Ынтырпрайз или жаба возвращается</h4>Я вернулся на java, где царил JPA, под капотом которого спрятался Hibernate. Легкость ушла, но осталось понимание того, как делать правильно. С переходом на GitFlow код стабилизировался, и мы решили потренироваться с миграцией между стабильными версиями схемы, хотя на тот момент это не было нужно.<br /><br />В качестве средства миграции мы выбрали <a href="http://code.google.com/p/flyway/">flyway</a>, который действительно был легковесным, если сравнивать с остальным миром ынтырпрайза. Он не находил сам разницы между схемами, не позволял возвращаться назад, в случае ошибки просто падал с ошибкой не предпринимая действий по откаду к стабильному состоянию - решения принятые авторами flyway. Тем не менее, он работал с обычными SQL-скриптами, что, в приципе, было достаточно для существования.<br /><br />Мы быстро освоились и на данный момент у нас более семидесяти миграций. Часть миграций исправляет миграции, написанные для неудачных ветвей разработки и это уже составляет некотороую проблему, поэтому хочется <a href="http://code.google.com/p/flyway/issues/detail?id=470">коллапсировать</a> все миграции до самой последней версии, находящейся в продакшене.<br /><br /><div style="text-align: left;">Но самая большая проблема поджидала нас, откуда никто не ожидал: распределенное версионирование. В распределенности сильно искажено понятие времени, как упорядоченной последовательности событий. Мы одновременно с коллегой начали вести разработку, моя миграция была создана раньше и получит меньший номер (который мы берем в формате<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">  </span></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">V201203211847__init_schema.sql</span>), чем его. Проблемы начнутся, если он вольет свои изменения в гланую ветвь раньше меня: его миграция окажется последней и спрячет мою, с меньшим номером. Как автоматически решать эту проблему, мы еще не придумали, поэтому просто обновляем метки времени перед слиянием, если кто-то добавил миграцибю до нас.</div></div>