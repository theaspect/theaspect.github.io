---
layout: post
title: API over ActiveMQ
date: '2013-11-30T19:51:00.001+07:00'
author: Constantine Linnick
tags:
- работа
- development
- message queue
modified_time: '2014-04-10T15:47:19.688+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-6561664659465783181
blogger_orig_url: http://blog.blzr.me/2013/11/api-over-activemq.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Открываю цикл постов про MQ и API. Прежде всего стоит определиться с терминологией: RMI или RPC. Method Invocation подразумевает за собой объекты и состояние, мы же будем рассматривать stateless вызовы, поэтому логичней это называть RPC. Лет пять назад Umputun рассказывал в одном из своих подкастов про то, как он спрашивал своих бойцов как бы они сделали RMI и для них это была вещь в себе, но ведь не "<a href="http://blog.blzr.me/2013/10/blog-post.html">боги горшки обжигают</a>".<br /><br /><a name='more'></a><br /><h4 style="text-align: left;">Постановка задачи</h4>Итак, для клиента нужен универсальный API. Мы почти сразу отказались от <a href="http://code.google.com/p/google-gson/">google-gson</a> и взяли java реализацию JMS - <a href="http://activemq.apache.org/">ActiveMQ</a>. Технология очень проста и позволяет очень быстро стартануть. Главный недостаток этого мы <a href="http://blog.blzr.me/2013/09/activemq-in-action.html">навелосипедили</a> очень много стандартных вещей. Чего хочется:<br />1. клиент авторизуется при подключении к серверу, соответственно аккаунты должны лежать в базе и быть нашими существующими аккаунтами<br />2. клиент может вызывать методы серверной реализации и получать результаты в том числе исключения, если таковые возникают<br />3. клиенты уведомляются о событиях на сервере, при этом события могут быть как широковещательными, так и P2P. Впоследствии от P2P мы отказались, поскольку подавляющая часть событий были широковещательными.<br />4. на будущее возможность подключать не только java клиенты будет очень привлекательна<br /><h4 style="text-align: left;">Низкий уровень</h4>В JMQ передача сообщений строится на двух концепциях: топики, сообщения получают все подписанты, и очереди, сообщение получает первый подписавшийся. С топиками все просто -&nbsp; они идеально подходят на роль широковещательных уведомлений. С очередями сложнее: у нас один слушатель - сервер и много писателей - клиенты, именно они инциируют посылку сообщений. Как же возвращать результат пославшему запрос? Есть <a href="http://activemq.apache.org/how-should-i-implement-request-response-with-jms.html">официальный</a> путь для этого: на каждое соединение клиент открывает временную очередь и сообщает серверу куда ему <strike>идти</strike> слать ответ через <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">JMSReplyTo</span>. Клиент у нас работает в синхронном режиме и ждет ответа.<br /><h4 style="text-align: left;">Java flavour</h4>Но тут есть проблема: таймаут на подключение 15 секунд, и две причины: очень долгий метод и очень большой ответ. В первом случае результат приходится посылать через уведомление (обычно он небольшого размера), а во втором бьется на небольшие чанки (обычно он достаточно быстрый). Натягивание совы многопоточности/асинхронности на однопоточный глобус JavaFX - тема для отдельного поста.<br /><br />Вторая проблема - сериализуемость. Когда клиент был только на java, мы не парились и сериализовались стандартным механизмом. Когда появился .Net, пришлось быстро перейти на XML и сериализоваться через <a href="http://xstream.codehaus.org/">XStream</a>. А для того, чтобы сохранить generic-чистоту кода, пришлось рожать такие конструкции:<br /><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">List</span><span class="o">&lt;SomeArg</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">Collection</span><span class="o">&lt;SomreResult</span><span class="o">&gt;</span>&nbsp;</span></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; getSmth<span class="o">(</span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="n">T</span> <span class="n">tags</span><span class="o">, Foo f, Bar b) throws SomeException</span><span class="o">;</span></span></div>К сожалению java конпелятор недостаточно умен для вывода типов (надеюсь с &lt;~&gt; все станет лучше) и для перегруженных методов приходится писать странные конструкции вида<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="o"></span></span><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">List</span><span class="o">&lt;SomeArg</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">Serializable</span><span class="o">&gt;</span> <span class="n">Collection</span><span class="o">&lt;SomreResult</span><span class="o">&gt;</span>&nbsp;</span></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; getSmth<span class="o">(</span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="o">Foo f, Bar b) throws SomeException</span><span class="o">{</span></span></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; return getSmth<span class="o">(</span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><b><span class="n">(T)</span></b> null<span class="n"></span><span class="o">, Foo f, Bar b)</span><span class="o">;</span></span></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="o">}</span></span></div><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="o"></span></span><div style="text-align: left;">Аннотировать&nbsp;<span class="nd"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">@SuppressWarnings</span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="o">(</span><span class="s">"RedundantCast"</span></span><span class="o"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">),</span></span><span class="o"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"> </span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"UnusedDeclaration"</span><span class="o">)</span></span><span class="o"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span></span>чтобы IDE не умничала и обрамлять их жирными <a href="http://blog.blzr.me/2013/06/blog-post.html">предупреждениями</a>: <b>НЕ ИСПРАВЛЯТЬ!!11ОДИНОДИН ВСЕ СЛОМАЕТСЯ КРОВЬ-КИШКИ</b>. Диагностика таких ошибок очень длительна и нетривиальна.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">В ActiveMQ очень легко добавить трансформер <a href="http://activemq.apache.org/maven/5.7.0/apidocs/org/apache/activemq/util/oxm/XStreamMessageTransformer.html">XStreamMessageTransformer</a>, который будет сериализовать объекты в XML. Единственная проблема с ним была в том, что он терял UserID в процессе сериализации, но починить это оказалось очень <a href="http://blog.blzr.me/2013/10/blog-post.html">легко</a>.&nbsp; </div><h4 style="text-align: left;">Высокий уровень </h4>Для развлечения я извлек модель очень похожую на то, что работает в  нашем проекте. Главный бонус здесь в том, что в песочнице можно  попробовать различные вещи, а затем перенести в проект. Собственно <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/mq/?at=default">код</a> состоит из трех частей: интерфейсы лежат в пакете <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">api</span>, серверная и клиентская реализации в <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">server </span>и <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">client </span>соответственно.<br /><br />Методы описаны в интерфейсе <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/mq/api/service/FooService.java?at=default">FooService</a>, события, посылаемые клиентом, описаны в виде inner static классов в <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/mq/api/service/Events.java?at=default">Events</a> после получения их очень удобно засылать как есть через гуавовский <a href="http://code.google.com/p/guava-libraries/wiki/EventBusExplained">EventBus</a> (<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">@Subscribe</span> в <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/mq/client/ClientApp.java?at=default">ClientApp</a>). Клиентское приложение стартует и вызывает методы с различным результатом (пустой, объект, исключение). <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/mq/client/ClientApp.java?at=default">Сервер</a> поднимает ActiveMQ и периодически засылает уведомления, параллельно отвечая на запросы. Я там продолжаю экспериментировать с DI через <a href="http://code.google.com/p/google-guice/">Guice</a> - пока не очень удобно. На клиенте самой интересной частью является runtime генерация клиентской реализации для интерфейсов через <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/mq/client/ServiceProxy.java?at=default">Proxy</a>. На сервере самая интересная часть - поиск серверной реализации вызванного метода в <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/mq/server/QueueServer.java?at=default">invoke</a>.<br /><h4 style="text-align: left;">Итог</h4>Если захочется поиграть, то запускаем сначала ServerApp, а потом ClientApp и наблюдаем за консолью. Продолжение полное танцев вприсядку про .Net и 1C с необычной развязкой следует...<br /><br /></div>