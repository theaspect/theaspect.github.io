---
layout: post
title: Тестирование файловой системы
date: '2013-05-31T09:12:00.002+07:00'
author: Constantine Linnick
tags:
- тестирование
- development
modified_time: '2014-04-10T15:47:19.617+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-1062434272150873008
blogger_orig_url: http://blog.blzr.me/2013/05/blog-post_31.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; margin-left: 1em; text-align: right;"><tbody><tr><td style="text-align: center;"><a href="http://s3.developerslife.ru/public/images/gifs/97d8bcd1-61e0-4c4a-a498-2bf15cc34773.gif" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" height="203" src="http://s3.developerslife.ru/public/images/gifs/97d8bcd1-61e0-4c4a-a498-2bf15cc34773.gif" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Симуляция реального мира в песочнице</td></tr></tbody></table>Май выдался богатым на новую и полезную информацию по тестированию: <a href="http://sergeyteplyakov.blogspot.com/2013/04/vs.html">цикл</a> <a href="http://sergeyteplyakov.blogspot.com/2013/04/blog-post_27.html">статей</a> от <a href="http://sergeyteplyakov.blogspot.com/2013/05/blog-post.html">Сергея</a> <a href="http://sergeyteplyakov.blogspot.com/2013/05/blog-post_13.html">Теплякова</a>, интересное <a href="http://www.radio-t.com/p/2013/05/04/podcast-339/">обсуждение</a> в Радио-Т.<br /><br />В это же время появилась интересная задача связанная с доступом к файловой системе. Алгоритм:<br />1. получаем список файлов<br />2. каким-то образом фильтруем<br />3. обрабатываем отфильтрованные файлы.<br /><br />Работа с ФС (по крайней мере в 6-й java) сосредоточена в классе <a href="http://docs.oracle.com/javase/6/docs/api/java/io/File.html">File</a>: list, delete, работа с путями. По сути эти методы относятся к сервису. Хочется иметь интерфейс чтобы убрать зависимость и получить возможность для подмены реализации, ну или хотя бы подмены <a href="http://blog.blzr.me/2012/08/blog-post_10.html">mock-ами</a> для тестирования.<br /><br />Конечно можно выйти из положения, создавая нужную иерархию в определенном месте файловой системы и работать с настоящим доступом, но что, если хочется просто протестировать алгоритм.<br /><h3 style="text-align: left;">Постановка задачи</h3>По заданному пути<br />удалить пять файлов<br />с учетом сортировки по возрастанию<br />имя которых начинается с цифр<br />содержащие первой строкой ШИББОЛЕТ.<br /><h3 style="text-align: left;">Решение</h3><div style="text-align: left;">Реализация находится <a href="https://bitbucket.org/theaspect/sandbox/src/tip/src/main/java/com/blazer/fs?at=default">здесь</a>, тесты <a href="https://bitbucket.org/theaspect/sandbox/src/tip/src/test/java/com/blazer/fs?at=default">здесь</a>.</div><h4 style="text-align: left;">Сервис</h4><div style="text-align: left;"><a href="https://bitbucket.org/theaspect/sandbox/src/tip/src/main/java/com/blazer/fs/FileService.java?at=default">FileService</a> представляет собой фактически обертку с некоторыми удобными методами<br /><br /></div><pre>public class FileService {<br />    /**<br />     * Get files in path<br />     */<br />    public Collection<file> dir(File path) {<br />        return Arrays.asList(path.listFiles());<br />    }<br /><br />    /**<br />     * Delete path<br />     */<br />    public void delete(File file) {<br />        if (!file.delete()) {<br />            log.debug("Cannot delete " + file.getPath());<br />        }<br />    }<br /><br />    /**<br />     * Open file<br />     */<br />    public InputStream openStream(File path) throws FileNotFoundException {<br />        return new FileInputStream(path);<br />    }<br /><br />    public Reader openReader(File path) throws FileNotFoundException {<br />        return new FileReader(path);<br />    }<br /><br />    public boolean isDir(File path) {<br />        return path.isDirectory();<br />    }<br />}<br /></file></pre><div style="text-align: left;"><h4 style="text-align: left;">Фильтрация</h4>Фильтрация <a href="https://bitbucket.org/theaspect/sandbox/src/tip/src/main/java/com/blazer/fs/Application.java?at=default">осуществляется</a> при помощи удобнейшего <a href="http://docs.guava-libraries.googlecode.com/git-history/release12/javadoc/com/google/common/collect/FluentIterable.html">FluentIterable</a>:<br /><br /><pre>public static Iterable<file> filter(FileService fileService, File dir, int count, String mask, String prefix) {<br />        return FluentIterable<br />                .from(Ordering.natural().immutableSortedCopy(fileService.dir(dir)))<br />                .filter(new NamePredicate(mask))<br />                .filter(new ContentPredicate(fileService, prefix))<br />                .limit(count)<br />                .toImmutableList();<br />    } </file></pre></div><div style="text-align: left;"></div><div style="text-align: left;"><br />И пары предикатов для фильтрации по <a href="https://bitbucket.org/theaspect/sandbox/src/tip/src/main/java/com/blazer/fs/NamePredicate.java?at=default">имени</a> и <a href="https://bitbucket.org/theaspect/sandbox/src/tip/src/main/java/com/blazer/fs/ContentPredicate.java?at=default">содержимому</a>. В предикат фильтрации по содержимому передается сервис файловой системы, плюс в Java 7 можно использовать очень удобный <a href="http://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html">try</a> для работы с Closeable ресурсами:</div><pre>public class ContentPredicate implements Predicate<file> {<br />    private FileService fileService;<br />    private String prefix;<br /><br />    public ContentPredicate(<b>FileService fileService</b>, String prefix) {<br />        this.fileService = fileService;<br />        this.prefix = prefix;<br />    }<br /><br />    @Override<br />    public boolean apply(@Nullable File file) {<br />        <b>try</b> (BufferedReader br = new BufferedReader(fileService.openReader(file))) {<br />            return prefix.equals(br.readLine());<br />        } catch (IOException ioe) {<br />            ContentPredicate.log.debug("Cannot read file " + file);<br />        }<br />        return false;<br />    }<br />}<br /></file></pre><div style="text-align: left;"><h3 style="text-align: left;">Тестирование</h3><div style="text-align: left;">С помощью mockito подменяем возвращаемые значения при тестировании <a href="https://bitbucket.org/theaspect/sandbox/src/tip/src/test/java/com/blazer/fs/PredicateTest.java?at=default">предикатов</a> и <a href="https://bitbucket.org/theaspect/sandbox/src/tip/src/test/java/com/blazer/fs/FullTest.java?at=default">фильтра</a>. Сами тесты получаются очень простыми и быстрыми:</div><div style="text-align: left;"><br /></div><pre>@Test<br />    public void FilterTest() throws FileNotFoundException {<br />        FileService fileService = Mockito.mock(FileService.class);<br />        File dir = new File("/test/dir");<br />        List<file> files = Arrays.asList(<br />                new File(dir, "100file.name"), // 0<br />                new File(dir, "bl"), // 1<br />                new File(dir, "099file.name"), // 2<br />                new File(dir, "bla"), // 3<br />                new File(dir, "098file.name"), // 4<br />                new File(dir, "blah"), // 5<br />                new File(dir, "097file.name")); // 6<br />        Mockito.when(fileService.dir(dir)).thenReturn(files);<br />        Mockito.when(fileService.openReader(files.get(6))).thenReturn(new StringReader("TEST"));<br />        Mockito.when(fileService.openReader(files.get(4))).thenReturn(new StringReader("TEST"));<br />        Mockito.when(fileService.openReader(files.get(2))).thenReturn(new StringReader("!!!!"));<br />        Mockito.when(fileService.openReader(files.get(0))).thenReturn(new StringReader("TEST"));<br /><br />        Iterable<file> result = Application.filter(fileService, dir, 3, "^\\d+.*$", "TEST");<br />        Iterator<file> i = result.iterator();<br />        Assert.assertEquals(files.get(6), i.next());<br />        Assert.assertEquals(files.get(4), i.next());<br />        Assert.assertEquals(files.get(0), i.next());<br />        Assert.assertFalse(i.hasNext());<br />    }<br /></file></file></file></pre><div style="text-align: left;"><h3 style="text-align: left;">Итог</h3>Из минусов: имеется обертка, которая нужна лишь для тестирования "DIP головного мозга". Плюсы: классы становятся простыми и легко модифицируемым, самая важную логику становится легко тестировать.</div></div></div>