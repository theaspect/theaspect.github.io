---
layout: post
title: Тиражирование Debian
date: '2013-03-24T23:47:00.000+07:00'
author: Constantine Linnick
tags:
- development
modified_time: '2014-04-10T15:47:19.633+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-1915061330624795925
blogger_orig_url: http://blog.blzr.me/2013/03/debian.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Когда впервые возникла необходимось подготовить образ системы к тиражированию, это было легко сделать: ставим систему, прописываем свои репозитории, устанавлиаем и настраиваем наш продукт, затем извлекаем флешку и через <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">dd</span> делаем образ. Флешка всего 8 гб, поэтому, предварительно зачистив свободное место на диске нулями из <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/dev/zero</span> удалось сжать образ до 300 мб.<br /><a name='more'></a><br /><br /><h4 style="text-align: left;">Первая проблема</h4><br />Первая проблема выяснилась очень быстро: при старте образа на новой машине сбивалась нумерация сетевых интерфейсов. Оказалось, по-умолчанию Debian жестко привязывает имена к MAC-адресам в файле <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/etc/udev/rules.d/70-persistent-net.rules</span>. Заново переставлять систему не было никакого желания, поэтому захотелось исправить файлик прямо в образе. Поскольку мы делали образ всего диска, а монтировать можно только файловую систему, необходимо было узнать топологию диска, чтобы найти необходимое смещение.<br /><br />Для того, чтобы узнать топологию файловой системы используем <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">fdisk</span>:<br /><div style="text-align: left;"><br /></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># fdisk -l -u image <br /><br />Disk image: 8019 MB, 8019099648 bytes<br />255 heads, 63 sectors/track, 974 cylinders, total 15662304 sectors<br />Units = sectors of 1 * 512 = 512 bytes<br />Sector size (logical/physical): 512 bytes / 512 bytes<br />I/O size (minimum/optimal): 512 bytes / 512 bytes<br />Disk identifier: 0x000b24e5<br /><br />Device Boot&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Blocks&nbsp;&nbsp; Id&nbsp; System<br />image1&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2048&nbsp;&nbsp;&nbsp; 14919679&nbsp;&nbsp;&nbsp;&nbsp; 7458816&nbsp;&nbsp; 83&nbsp; Linux<br />image2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 14921726&nbsp;&nbsp;&nbsp; 15661055&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 369665&nbsp;&nbsp;&nbsp; 5&nbsp; Extended<br />image5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 14921728&nbsp;&nbsp;&nbsp; 15661055&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 369664&nbsp;&nbsp; 82&nbsp; Linux swap / Solaris<br /><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;</span></span></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-family: Arial,Helvetica,sans-serif;">Блоки у нас по 512 байт</span> </span></div><div style="text-align: left;"><br /></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># echo 2048*512 | bc<br />1048576<br />&nbsp;</span></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-family: Arial,Helvetica,sans-serif;">Файлы монтируются при помощи <span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><a href="http://en.wikipedia.org/wiki/Loop_device">loop device</a></span>.&nbsp;</span> </span></div><div style="text-align: left;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># mount -t ext3 -o loop,offset=1048576 image /mnt</span></div><br />После чего успешно зачищаем файл с настройками интерфейсов. При следующей загрузке нумерация, как и положено, пойдет с <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">eth0</span>.<br /><h4 style="text-align: left;"><span style="font-family: Arial,Helvetica,sans-serif;">Вторая проблема</span></h4>Второй затык не заставил себя долго ждать: необходимо было загрузить систему, чтобы установить дополнительный софт. Не смотря на то, что мы работаем в Ubuntu, использовать chroot окружение очень не хотелось. Смонтировать одну файловую систему было уже нельзя - необходимо было работать со всем образом. Сделать это можно при помощи <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">losetup</span>, который на самом деле вызывался при монтировании образа:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">#losetup /dev/loop0 image</span><br /><br />Не забыть поменять права, иначе нельзя будет работать с устройством (при этом права <b>постоянно сбрасываются</b> на <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">root:disk</span>)<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">#chown user:user /dev/loop0</span><br /><br />В VirtualBox есть <a href="http://www.virtualbox.org/manual/ch09.html#rawdisk">возможность</a> работать с loopback устройствами, но в интерфейсе её нет, а командная строка предупреждает:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">WARNING: This is a development tool and shall only be used to analyse<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; problems. It is completely unsupported and will change in<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; incompatible ways without warning.<br /></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$ VBoxManage internalcommands createrawvmdk -filename ~/workspace/image.vmdk -rawdisk /dev/loop0<br />RAW host disk access VMDK file /home/constantine/workspace/image.vmdk created successfully.</span><br /><br /><a href="http://www.virtualbox.org/manual/ch08.html">Создаем</a> машину<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$ VBoxManage createvm --name loop<br />$ VBoxManage registervm ~/VirtualBox\ VMs/loop/loop.vbox <br />$ VBoxManage storagectl loop --name sata --add sata</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$ VBoxManage storageattach loop --storagectl ide0 --port 0 --device 0 --type hdd --medium /home/constantine/workspace/image.vmdk</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$ VBoxManage startvm loop</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Waiting for VM "loop" to power on...<br />VM "loop" has been successfully started.</span><br /><h4 style="text-align: left;">Третья проблема</h4>Третья проблема появилась, когда мы захотели залить образ на диск большего размера и было бы очень обидно на дорогущем 160 гб SSD диске использовать первые 8 гб. Для этого пришлось жонглировать флешками с <a href="http://clonezilla.org/">Clonezilla</a> и <a href="http://gparted.sourceforge.net/livecd.php">GParted</a>, поскольку с первого раза развернуть образ никак не удавалось. Очень быстро это надоело. К счастью, оказалось что в clonezilla имеется консольная версия <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">parted</span>. В процессе были весьма неочевидные проблемы с изменением размеров разделов: разделы нельзя было менять местами, а только расширение вправо, перемещение, сжатие слева - тут могу наврать. Как в следующий раз будем заливать - допишу.<br /><h4 style="text-align: left;">На будущее </h4>В идеале хотелось бы автоматизировать создание образов заданного размера по нажатию одной кнопки или сразу по стабильному билду из CI. В первом приближении: ставим на <a href="http://wiki.qemu.org/Index.html">QEMU</a> при помощи <a href="http://wiki.debian.org/DebianInstaller/Preseed">preseed</a> файла из стандартного образа Debian. Затем стартуем машину, через ssh производим необходимые настройки и дампим образ жесткого диска. Есть ощущение, что одного preseed файла не хватит, хотя у него и весьма богатые возможности.</div>