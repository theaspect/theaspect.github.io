---
layout: post
title: Дело о пропавшей памяти
date: '2012-07-21T22:22:00.001+07:00'
author: Constantine Linnick
tags:
- development
modified_time: '2014-04-10T15:46:23.683+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-8855155257733885995
blogger_orig_url: http://blog.blzr.me/2012/07/blog-post_21.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Начали тестировать наш продукт, и система мониторинга на железке, оставленной на выходные неизменно рапортовала об отсутствии памяти. Причем график потребления памяти подозрительно линейно рос даже на простаивающей системе. И если на девелоперской среде можно было списать на отладочный режим, то на продакшене ничего подобного не было.<br /><br />Сначала подключили родной профайлер, но без NetBeans он ничего интересного не показывал. Пришлось подключать тяжелую артиллерию в лице JProfier. Поковырявшись в огромной куче разных метрик нашли хотспоты в памяти. Подозрение пало на ту самую систему мониторинга. После рассматривания исходников выяснилось, что гибернейтовский EntityManager перзистил в базу собранные показатели жизнедеятельности системы и после этого не очищался. Контекст за день распухал на десятки тысяч объектов, которые были недосягаемы для мусорщика. Принцип неопределенности мониторинга: неправильно написанный мониторинг успешно убивает наблюдаемую систему.<br /><br />Вывод капитана: в долгоживущих демонах и приложениях, написанных на java все так же нужно следить за памятью, чтобы не оставалось ссылок на ненужные объекты. По ощущениям ошибка того же уровня, что и склеивание большого количества строк: такая же простая и настолько же драматически влияющая на производительность.</div>