---
layout: post
title: Как я патчил Jetty
date: '2013-10-20T00:28:00.001+07:00'
author: Constantine Linnick
tags:
- open source
- работа
- development
modified_time: '2014-04-10T15:47:19.668+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-4709425635187395225
blogger_orig_url: http://blog.blzr.me/2013/10/jetty.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><h4 style="text-align: left;">Постановка задачи </h4>Freeswitch умеет при помощи <a href="http://wiki.freeswitch.org/wiki/Mod_curl">mod_curl</a> забирать с определенного урла диалпланы и пользователей. Это очень чуствительная информация, поэтому очень захотелось ограничить доступ к служебным урлам только с localhost.<br /><a name='more'></a><br /><h4 style="text-align: left;">Реализация </h4><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; margin-left: 1em; text-align: right;"><tbody><tr><td style="text-align: center;"><a href="http://www.focusst.org/forum/attachments/focus-st-discussions/7928d1366422791-what-made-you-want-st-sim.png" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" height="288" src="http://www.focusst.org/forum/attachments/focus-st-discussions/7928d1366422791-what-made-you-want-st-sim.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">One does not simply restrict access <br />to single URL from localhost</td></tr></tbody></table>В Jetty имеется <a href="http://www.eclipse.org/jetty/documentation/current/ipaccess-handler.html">IPAccessHandler</a> джавадок который представляет собой сплошной вотзефак. Методом проб и ошибок выяснилось что фраза: <i>An empty white list is treated as match all. If there is at least one entry in         the white list, then a request must match a white list entry</i> - означает ровно то что написано. Т.е. переводя на человеческий: нельзя просто так взять и ограничить доступ к одному урлу с localhost.<br /><br />В итоге такая конфигурация решала задачу:<br /><pre>&lt;set name="black"&gt;<br />    &lt;array type="String"&gt;<br />        &lt;item&gt;-126.-.-.-|/fs/*&lt;/item&gt;<br />        &lt;item&gt;127.0.0.2-|/fs/*&lt;/item&gt;<br />        &lt;item&gt;128-.-.-.-|/fs/*&lt;/item&gt;<br />    &lt;/array&gt;<br />&lt;/set&gt;<br /></pre><h4 style="text-align: left;">Хватит это терпеть</h4>Пошел искать мейллист, <a href="http://www.eclipse.org/jetty/mailinglists.php">нашел</a> jetty-dev, прошел квест по регистрации и заслал <a href="http://dev.eclipse.org/mhonarc/lists/jetty-dev/msg01930.html">enchansement proposal</a>. Пришел Greg Wilkins, и предложил <a href="http://dev.eclipse.org/mhonarc/lists/jetty-dev/msg01935.html">альтернативное</a> решение: не расширять синтаксис правил фильтрации, а сделать альтернативный режим в котором правило будет применяться только если заматчился URL, для чего нужно вывернуть процесс фильтрации наизнанку.<br /><br />В общем, спустя пару недель, собрался с силами и таки засел за патч. Причем код писать пришлось под убунтой: на винде я так и не смог сконпелировать исходники. Разбил патч на два: выворачивание наизнанку (потратил кучу времени на борьбу с тестовыми случаями - оказалось баг) и добавление режима.<br /><h4 style="text-align: left;">Высокий порог вхождения</h4><div style="text-align: left;">Это тема для отдельного поста, но, чтобы заслать патч в какой-нибудь серьезный проект, нужно <b>реально очень сильно</b> этого хотеть. Наученный горьким опытом, я пошел искать официальный гайд по <a href="http://www.eclipse.org/jetty/documentation/current/contributing-patches.html">засылке патча</a>, в котором оказались ссылки еще на два гайда: по работе с <a href="http://wiki.eclipse.org/Development_Resources/Contributing_via_Git">гитом</a> и <a href="https://git.eclipse.org/r/Documentation/user-upload.html">герритом</a>. Оооокей, пошел курить.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Читаю: подпишите CLA. Для начала нужно зарегаться, ищу, регистрируюсь, подписываю что весь код написан лично мной. Дальше: прежде чем пушить, убедитесь что создан тикет в багзилле. Оооок, создаю <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=418732">тикет</a> со ссылкой на обсуждение.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Пушу в специальный репозиторий, привязанный к герриту - отлуп, ключ говорит давай. Регаю публичный ключ. Повторяю - отлуп. Не подписал, говорит CLA. Проверил - подписано, повторяю - отлуп. Пошел дальше курить, оказалось в коммите нужно указать специальным тегом, Signed-off-by себя, а ревьюер потом еще себя укажет другими тегами.</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://marshallmashup.usc.edu/wp-content/uploads/2013/02/success.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="256" src="http://marshallmashup.usc.edu/wp-content/uploads/2013/02/success.jpg" width="320" /></a></div><div style="text-align: left;">В процессе редактирования коммитов проникся интерактивным ребейзом (в hg есть <a href="http://mercurial.selenic.com/wiki/HisteditExtension">аналог</a>). Наконец заслал <a href="https://git.eclipse.org/r/#/c/17070/">два</a> <a href="https://git.eclipse.org/r/#/c/17071/">патча</a>. Которые спустя две недели Greg проверил и <a href="http://git.eclipse.org/c/jetty/org.eclipse.jetty.project.git/log/?qt=grep&amp;q=418732">запушил</a>. Успех.</div></div>