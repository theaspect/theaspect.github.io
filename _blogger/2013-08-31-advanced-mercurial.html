---
layout: post
title: Advanced Mercurial
date: '2013-08-31T17:45:00.000+07:00'
author: Constantine Linnick
tags:
- контроль версий
- development
modified_time: '2014-04-10T15:47:19.685+07:00'
thumbnail: http://2.bp.blogspot.com/--fwPzPdzaVE/UiG2BlfBPMI/AAAAAAAACHg/ku12UL7QfLI/s72-c/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-6128363611644161826
blogger_orig_url: http://blog.blzr.me/2013/08/advanced-mercurial.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/--fwPzPdzaVE/UiG2BlfBPMI/AAAAAAAACHg/ku12UL7QfLI/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://2.bp.blogspot.com/--fwPzPdzaVE/UiG2BlfBPMI/AAAAAAAACHg/ku12UL7QfLI/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" height="285" width="320" /></a></div>Очень много людей вокруг, активно используют Mercurial, но при этом ограничиваются базовыми вещами типа <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">push/pull/commit/update</span> да и те выполняются через tortoisehg. Я в начале августа выступал с рассказом о чрезвычайно полезных фичах, про которые, когда начал пользоваться, думаешь: как же я жил без этого раньше. Слайды оформлю в виде шпаргалки.<br /><h4 style="text-align: left;"><a name='more'></a>GitFlow</h4><div style="text-align: left;">Тут важен даже не инструмент, а сам подход. Есть перевод на <a href="http://habrahabr.ru/post/106912/">русский</a>. Зачем это нужно становится понятно, когда в одном проекте начинают работать человек пять. Мы медленно <a href="http://blog.blzr.me/2013/04/blog-post.html">пришли</a> к понимаю необходимости. </div><h4 style="text-align: left;">Rebase</h4><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-WA8iAukSoNw/UiG4TP_fHLI/AAAAAAAACH0/iPVViCd5nj8/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://1.bp.blogspot.com/-WA8iAukSoNw/UiG4TP_fHLI/AAAAAAAACH0/iPVViCd5nj8/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" height="77" width="320" /></a></div><div style="text-align: left;">Крайне полезный инструмент, который может показаться немного не интуитивным. Рассмотрим ситуацию: вы пилите фичу в отдельной ветке, регулярно пуша изменения в центральный репозиторий и периодически подтягивая из него изменения. История может выглядеть так.</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-ttqTMuxGCc4/UiG5cDCIsvI/AAAAAAAACH8/xsGsn9FjPnE/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://2.bp.blogspot.com/-ttqTMuxGCc4/UiG5cDCIsvI/AAAAAAAACH8/xsGsn9FjPnE/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" height="114" width="320" /></a></div><div style="text-align: left;">В случае же с <a href="http://www.selenic.com/mercurial/hg.1.html#rebase">ребейзом</a> история начинает выглядеть так. Ценой сохранения изменений локально можно сохранить историю чистой не подмешивая в diff изменения из других веток. Главным минусом тут является отсутствие пуша в центральный репозиторий. Жесткий диск может полететь, наводнение, метеорит. Про это же говорят в <a href="http://www.youtube.com/watch?v=PR8BhFv9KAU&amp;feature=share">JetBrains</a>, но Мэт готовит достойный ответ: <a href="http://mercurial.selenic.com/wiki/ChangesetEvolution">эволюционирующая история</a>, которая пока в процессе разработки.</div><h4 style="text-align: left;">Стриптиз</h4><div style="text-align: left;">Иногда нужно удалить ветку, совсем удалить, на случай если вы закоммитили "<a href="http://mercurial.selenic.com/wiki/EditingHistory">launch codes for the nuclear arsenal</a>". Для этого есть команда <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hg strip abcd1234</span>. Которая удалит ветку. Если вдруг ветка ушла в центральный репозиторий, то придется выполнить стрип всей команде.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Если вы, выполнив эту <a href="http://www.selenic.com/mercurial/hg.1.html#strip">команду</a>, вдруг передумали или стрипнули лишнего и хотите все вернуть взад как было, то не беда: после стрипа меркуриал пишет что-то вроде <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">saved backup bundle to A:\Work\Temp\.hg\strip-backup\e0d0e313de56-backup.hg</span>. Многие, если не все, необратимые команды делают бекап, который можно восстановить командой: <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hg unbundle "A:\Work\Temp\.hg\strip-backup\e0d0e313de56-backup.hg"</span>. Кавычки нужны, если есть пробелы.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Просто удалить коммиты, оставив файлы в неизменном состоянии позволит <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hg strip -k abcd1234</span>. Часто пользовался этим ключом, пока не узнал про следующую фишку.</div><h4 style="text-align: left;">Amend</h4><div style="text-align: left;">Этот ключ добавили совсем недавно, <a href="http://www.selenic.com/mercurial/hg.1.html#commit">позволяет</a> обновить предыдущий коммит (если он еще не запушен): добавить или удалить файлы, изменить текст коммита. Команда <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hg commit --amend -m "Текст сообщения"</span>. Если не указать текст, то откроется текстовый редактор с предыдущим сообщением. </div><h4 style="text-align: left;">Сдвиг по фазе</h4><div style="text-align: left;">Мощная архитектурная фича, которая сейчас пронизывает очень многие и позволяет реализовать много интересных вещей. В репозитории есть три <a href="http://www.selenic.com/mercurial/hg.1.html#commit">фазы</a>. </div><div style="text-align: left;"><b>public</b> - коммит ушел наружу или пришел снаружи, его нельзя менять (например через --amend или ребейзить) </div><div style="text-align: left;"><b>draft</b> - коммит находится только в текущем репозитории и его можно покойно менять</div><div style="text-align: left;"><b>secret</b> - коммиты исключаются из синхронизации с центральным репозиторием. Поднять фазу на более публичную можно, опустить - нет (на самом деле можно, но через <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">--force</span> "да я понимаю что я делаю").</div><h4 style="text-align: left;">А хто это наделал?</h4><div class="separator" style="clear: both; text-align: center;"><a href="http://www.jetbrains.com/img/webhelp/highlightRevisions.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://www.jetbrains.com/img/webhelp/highlightRevisions.png" /></a></div><div style="text-align: left;">Командой <a href="http://www.selenic.com/mercurial/hg.1.html#annotate">annotate</a> можно посмотреть кому принадлежит конкретная строка, когда и в какой ревизии она была изменена, посмотреть текст сообщения чтобы понять зачем это было написано. IntellijIDEA <a href="http://www.jetbrains.com/idea/webhelp/working-with-annotations.html">позволяет</a> это делать прям в исходнике. Это стало просто must have фичей. Тем не менее это можно сделать через <a href="http://stackoverflow.com/questions/5890843/annotate-feature-in-tortoisehg">tortoisehg</a> нажав неприметную кнопочку. Ну или через консоль в конце концов.</div><h4 style="text-align: left;">Cherry Picking</h4><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-nZcan1E_j_s/UiHH8KPiXsI/AAAAAAAACIk/-jiUx_XkP-A/s1600/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA.PNG" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://4.bp.blogspot.com/-nZcan1E_j_s/UiHH8KPiXsI/AAAAAAAACIk/-jiUx_XkP-A/s1600/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA.PNG" /></a></div><div style="text-align: left;"><a href="http://2.bp.blogspot.com/-xXMIpGv6MDc/UiHHqBSJGFI/AAAAAAAACIc/_FNoK5URYN4/s1600/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA.PNG" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"></a>Совсем недавно узнал про эту очень полезную штуку: командой <a href="http://www.selenic.com/mercurial/hg.1.html#graft">graft</a> можно скопировать и замерджить изменения из произвольного чейнджсета. Можно передавать багфиксы без мерджа двух веток. При этом нужно поддерживать чистоту коммитов (чтобы не перенсти чего-нибудь лишнего либо, наоборот, недонести). При этом tortoisehg нарисует пунктирную линию.</div><h4 style="text-align: left;">Поиск по ревизии или фрагменту сообщения </h4><div style="text-align: left;">В <a href="http://mercurial.selenic.com/wiki/TipsAndTricks">tips and tricks</a> написано про <a href="http://www.selenic.com/mercurial/hg.1.html#log"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">log -k</span></a>. Удобно искать номера тикетов и числовой номер ревизии по хэшу. В последних tortoisehg можно нажать <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">View-Filter toolbar</span> и вводить поисковый запрос в поле. Раньше как-то с этим были проблемы, в последнем всё работает.</div><h4 style="text-align: left;">Игнорим хлам</h4>Любая  IDE создает в репозитории кучу бинарного хлама и временных файлов. В  процессе коммита приходится продираться через десятки лишних файлов,  немудрено пропустить что-нибудь важное, либо запушить всем коллегам свои  настройки. Синтаксис файла <a href="http://www.selenic.com/mercurial/hgignore.5.html">.hgignore</a> очень простой, при этом сплошные бенефиты.<h4 style="text-align: left;">Shelve</h4><div style="text-align: left;">Фича <a href="http://tortoisehg.bitbucket.org/manual/2.8/shelve.html">tortoisehg</a>, позволяет сохранить незакоммиченные изменения в отдельное хранилище, если, например, потребовалось посреди работы срочно переключиться на другую ветку, а коммитить текущие изменения не хочется. У самого меркуриала есть плагины <a href="http://mercurial.selenic.com/wiki/ShelveExtension">shelve</a> и <a href="http://mercurial.selenic.com/wiki/AtticExtension">attic</a>, которые, увы, не идут в стандартной поставке.</div><h4 style="text-align: left;">Консоль под рукой</h4><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-lUVvbcOwMFk/UiHCjOl7JAI/AAAAAAAACIM/5vd9AyAteY8/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://3.bp.blogspot.com/-lUVvbcOwMFk/UiHCjOl7JAI/AAAAAAAACIM/5vd9AyAteY8/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" height="141" width="320" /></a></div><div style="text-align: left;">Опять же в tortoisehg есть консоль, которая позволит пользоваться нереализованными еще в интерфейсе фишками типа --amend. Весьма неочевидно что в окне лога можно набирать и выполнять консольные команды.</div><h4 style="text-align: left;">Не забываем закрывать ветки</h4><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-33mpyPCFzOI/UiG3G_JgqBI/AAAAAAAACHo/fgIsCcU6Rh4/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://2.bp.blogspot.com/-33mpyPCFzOI/UiG3G_JgqBI/AAAAAAAACHo/fgIsCcU6Rh4/s1600/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B9.png" height="130" width="320" /></a></div><div style="text-align: left;">Влитые и мертвые ветки нужно закрывать как можно раньше, чтобы не получалось такого. Ценой потери хэшей можно изредка <a href="http://blog.blzr.me/2013/05/blog-post_7.html">сортировать</a> репозиторий. Хотя, спустя какое-то время история уходит вперед и это безобразие перестает мозолить глаза в повседневной работе. Так что опционально.</div><h4 style="text-align: left;">Прочее </h4><div style="text-align: left;">Как хранить <a href="http://blog.blzr.me/2013/06/mercurial.html">документацию</a>, <a href="http://blog.blzr.me/2013/04/blog-post_21.html">схему базы</a>, зачищать лишние <a href="http://blog.blzr.me/2013/04/blog-post_20.html">бинарные файлы</a>.</div></div>