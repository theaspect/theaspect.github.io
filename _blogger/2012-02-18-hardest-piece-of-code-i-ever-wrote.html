---
layout: post
title: The hardest piece of code I ever wrote
date: '2012-02-18T15:00:00.000+07:00'
author: Constantine Linnick
tags:
- open source
- ретроспектива
- контроль версий
modified_time: '2013-04-15T23:02:22.998+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-8888697677033118966
blogger_orig_url: http://blog.blzr.me/2012/02/hardest-piece-of-code-i-ever-wrote.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div class="entry-content"><a href="http://doublefail.com/files/2010/04/hurdling-fail.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://doublefail.com/files/2010/04/hurdling-fail.jpg" height="320" width="243" /></a>Наконец то можно рассказать кулстори, как я патчил  mercurial.<br /><a name='more'></a><i>Предыстория</i><br />В октябре у нас устаканилась работа с  репозиторием и родилась идея как-то выделить на графе дефолтовую ветвь. Пару  часов после работы повспоминал питон, погрепал сорцы и нашел место, которое  отрисовывало линию и задал ему отрисовку более толстой линией.<br /><br /><i>Попытка  1</i><br />Идея показалась удачной и я приперся в рассылку меркуриала и скинул им  идею. <a href="http://www.selenic.com/pipermail/mercurial-devel/2011-October/034880.html">http://www.selenic.com/pipermail/mercurial-devel/2011-October/034880.html</a>  На что получил закономерный ответ: идея хорошая, но хочется конфигурируемости -  не у всех главная ветка является default, в частности у них главная - stable.  Fail<br /><br /><i>Попытка 2</i><br />Я забил, да и ковырять было лень, пока на  новогодних выходных наконец не разобрался как доступаться к конфигам. После чего  сделал патч, залил на pastebin и снова запостил в рассылку. <a href="http://www.selenic.com/pipermail/mercurial-devel/2012-January/036799.html">http://www.selenic.com/pipermail/mercurial-devel/2012-January/036799.html</a>  Оказалось, они там все ленивые и всё автоматизировали, поэтому патчи принимаются  только через patchbomb. Fail<br /><br /><i>Попытка 3</i><br />Разобрался с патчбомбой  и снова отправил. После чего Мэтт сделал пару замечаний и отправил меня курить  регламенты. Еще он сказал, что толщина, конечно, хорошо, но народ захочет  задавать и цвет, после чего начал требовать от меня дискуссии. <a href="http://www.selenic.com/pipermail/mercurial-devel/2012-January/036828.html">http://www.selenic.com/pipermail/mercurial-devel/2012-January/036828.html</a>  Короче мы друг друга не поняли, и я ушел исправлять кодестайл и впиливать цвет.  Fail<br /><br /><i>Попытка 4</i><br />Следующая перестрелка письмами растянулася на  неделю. Мэтт многозначительно вздыхал <a href="http://www.selenic.com/pipermail/mercurial-devel/2012-January/036857.html">http://www.selenic.com/pipermail/mercurial-devel/2012-January/036857.html</a>  а я всё еще не понимал чего от меня хотят, но пошел фиксить.  Fail<br /><br /><i>Попытка 5</i><br />Учел все исправления, запустил часовое  тестирование, коллапсировал изменения в один патч и снова отправил. На что Мэтт  ответил, что коллапсировать не надо и коммиты должны быть атомарными <a href="http://www.selenic.com/pipermail/mercurial-devel/2012-January/037263.html">http://www.selenic.com/pipermail/mercurial-devel/2012-January/037263.html</a>  Fail<br /><br /><i>Попытка 6</i><br />Руками разбиваю коммит на две части: для цвета и  толщины. <a href="http://www.selenic.com/pipermail/mercurial-devel/2012-January/037574.html">http://www.selenic.com/pipermail/mercurial-devel/2012-January/037574.html</a>  Но, окно уже закрылось, и патчи принимают только с февраля.  Fail<br /><br /><i>Попытка 7</i><br />Жду 2 февраля, переотправляю патч. Мэтт не  отвечает, зато приходит Мартин и фигачит еще одну порцию замечаний. <a href="http://www.selenic.com/pipermail/mercurial-devel/2012-February/037874.html">http://www.selenic.com/pipermail/mercurial-devel/2012-February/037874.html</a>  Fail<br /><br /><i>Попытка 8</i><br />Исправляю руками diff файл, отправляю, проверяю  почту и замечаю ошибку <a href="http://www.selenic.com/pipermail/mercurial-devel/2012-February/037933.html">http://www.selenic.com/pipermail/mercurial-devel/2012-February/037933.html</a>  Fail<br /><br /><i>Попытка 9</i><br />Быстро исправляю и отправляю снова. <a href="http://www.selenic.com/pipermail/mercurial-devel/2012-February/038098.html">http://www.selenic.com/pipermail/mercurial-devel/2012-February/038098.html</a>  Проходит неделя, отправляю письма Мартину, на что он еще через неделю посылает  меня в их IRC канал. Прихожу и спрашиваю, есть ли тут коммитеры. На канале меня  узнают: "а та самая фигня с графом". Находится Патрик, который читает всю  переписку, и переколбашивает к херам оба моих патча <a href="http://mezard.eu/hg/hg-does-it-look-good-for-you/rev/41a5282461cf">http://mezard.eu/hg/hg-does-it-look-good-for-you/rev/41a5282461cf</a>  Ну и спрашивает устраивают ли меня его изменения, и если всё ок, он запушит  измнения в дефолт. Пока мы общались на тему "что за гребаная Спарта у них в  разработке", внезапно пришел Мэтт и запушил мою версию изменений <a href="http://www.selenic.com/hg/graph/41fc1e078d68">http://www.selenic.com/hg/graph/41fc1e078d68</a>,  а Патрик пообещал отправить свои правки отдельными патчами. <b>Double  win</b>.</div><span class="attachment"></span></div>