---
layout: post
title: Бизнес-логика в базе
date: '2013-04-24T01:35:00.000+07:00'
author: Constantine Linnick
tags:
- боль
- тестирование
- контроль версий
- development
modified_time: '2014-04-10T15:47:19.644+07:00'
thumbnail: http://4.bp.blogspot.com/-snNsJBXciw0/UXa7Zn1RCVI/AAAAAAAABzw/0bBgm8bTf_k/s72-c/sql.jpg
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-3317131671025006324
blogger_orig_url: http://blog.blzr.me/2013/04/blog-post_24.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; margin-left: 1em; text-align: right;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-snNsJBXciw0/UXa7Zn1RCVI/AAAAAAAABzw/0bBgm8bTf_k/s1600/sql.jpg" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" src="http://4.bp.blogspot.com/-snNsJBXciw0/UXa7Zn1RCVI/AAAAAAAABzw/0bBgm8bTf_k/s1600/sql.jpg" width="200" /></a></td></tr><tr><td class="tr-caption" colspan="2" style="text-align: center;"><br /><div style="text-align: center;">Типичный опердень</div><div style="text-align: left;">Выборка 41.5%</div><div style="text-align: left;"><span style="color: #20124d;">Фильтрация 5.8%</span><br /><div><div style="text-align: left;"><span style="color: #4c1130;">Обработка 13.4%</span></div><div style="text-align: left;"><span style="color: #7f6000;">Аналитика 17.7%</span></div><div style="text-align: left;"><span style="color: #274e13;">Пост-обработка 21.6%</span></div><div style="text-align: left;"><span style="color: #660000;">Комментарии 0%</span></div></div></div></td></tr></tbody></table><h3 style="text-align: left;">Или почему это зло</h3><h4 style="text-align: left;">Если бизнес-логика в базе</h4><div style="text-align: left;">Первая по важности - это богатые возможности СУБД: умный оптимизатор, который может работать с индексами и собирать статистику, что драматически сокращает объем считываемых данных и памяти; под рукой дешевые джойны по внешним ключам; агрегатные и аналитические функции; группировка и сортировка; фильтрация.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Второе - возможность легко и непринужденно использовать результат такого запроса в качестве источника данных.</div><h4 style="text-align: left;">Если бизнес-логика в приложении</h4><div style="text-align: left;">Нет размазывание бизнес-логики между приложением, и базой. Что же такого на стороне приложения?</div><div style="text-align: left;">1. Не нужно вырезать и вставлять куски кода, чтобы их прогнать в изолированном окружении </div><div style="text-align: left;">2. Легкая отладка - можно остановиться в любом месте обрабоки и посмотреть на данные</div><div style="text-align: left;">3. <a href="http://blog.blzr.me/2013/04/blog-post_21.html">Версионирование</a> - кто вообще версионирует код, в базе?</div><div style="text-align: left;">4. Легковесность базы - нет логики, достаточно простого SQL, нет требований к базе, можно на коленке разворачивать схему любой версии на любой пользовательской машине. Когда база всего-лишь тупое хранилище данных, нам для работы достаточно командной строки, в идеале поля для выполнения кода с подсветкой синтаксиса. Сам билд становится переносимым, позволяя развернуть рабочее приложение на чистой машине.</div><div style="text-align: left;">5. Декларативный подход против императивно-функционального - СУБД сама выбирает оптимальный порадок выборки данных, зато во втором варианте процесс обработки можно "читать"</div><div style="text-align: left;">6. Комментарии - их нет. Ноль целых ноль десятых процента. Какой смысл их писать, если один кусочек логики размазывается по всему запросу? В случае пошаговой обработки можно пояснять что мы делаем на каждом этапе и почему.</div><div style="text-align: left;">7. Пошаговость процесса и функциональный стиль написания - позволяет писать <a href="http://blog.blzr.me/2013/03/blog-post_26.html">тесты</a>. Тестирование кода, работающего с базой - это уже джедайские практики. Я ни разу не видел тестов внутри базы, покрывающих пакеты, хотя инструменты <a href="http://docs.oracle.com/cd/E15846_01/doc.21/e15222/unit_testing.htm">имеются</a>.</div><div style="text-align: left;">8. Возможность написать высокоуровневый DSL, который будет адаптирован к бизнес-домену, что позволит транслировать код в SQL с жутким мультипликатором. На эту тему у ребе metaclass <a href="http://metaclass.livejournal.com/800013.html">можно</a> <a href="http://metaclass.livejournal.com/777541.html">прочитать</a> <a href="http://metaclass.livejournal.com/667267.html">много</a> <a href="http://metaclass.livejournal.com/707171.html">интересного</a>.</div><h4 style="text-align: left;">Минусы хранения логики в приложении</h4><div style="text-align: left;">1. ORM, которые строят сложные и, порой, неоптимальные запросы. А еще, многие из них не умею работать с курсорами, что усложнает написание кода в функциональном стиле с минимумом побочных эффектов. Претензий <a href="http://blog.blzr.me/2012/09/perfect-orm.html">много</a>.</div><div style="text-align: left;">2. Резко вырастает объем данных, которые нужно загрузить для выборки, одна из причин, по которой аппликейшен сервер держат поближе к базе данных (в сравнении с расстоянием до клиента).</div><h4 style="text-align: left;">Итог</h4><div style="text-align: left;">Время разработчика дорого, серверные мощности дешевы. Поэтому за повышение скорости разработки и упорядочивание бизнес-логики платят скоростью работы запросов (с которым борются закидывая мощными железками), общей сложностью системы (трехзвенка вместо двухзвенки) и требованием к квалификации разработчика - круг замкнулся.<br /><h4 style="text-align: left;">P.S. Пояснения к легенде </h4>Выборка - это Select и Join,<br />Фильтрация - Where и Having,<br />Обработка - различные функции, рассчеты, кейсы,<br />Аналитика - агрегатные и аналитические функции,<br />Пост-обработка - захардкоженные константы, сортировка и группировка.﻿</div><div style="text-align: left;"><br /></div></div>