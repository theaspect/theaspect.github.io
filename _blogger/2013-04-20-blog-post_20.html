---
layout: post
title: Липосакция репозитория
date: '2013-04-20T21:45:00.000+07:00'
author: Constantine Linnick
tags:
- контроль версий
- development
modified_time: '2014-04-10T15:47:19.755+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-9007225827623690487
blogger_orig_url: http://blog.blzr.me/2013/04/blog-post_20.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; margin-left: 1em; text-align: right;"><tbody><tr><td style="text-align: center;"><a href="http://s3.developerslife.ru/public/images/gifs/a71a7a56-b751-4470-bc72-2b7a794b2387.gif" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" src="http://s3.developerslife.ru/public/images/gifs/a71a7a56-b751-4470-bc72-2b7a794b2387.gif" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Сборка HelloWorld на Maven</td></tr></tbody></table><h3 style="text-align: left;">Предыстория </h3>До того, как мы <a href="http://blog.blzr.me/2012/03/lot-of-fun.html">переехали</a> на maven, мы жили в счастливом неведении: проект собирал нам eclipse, бинарные зависимости хранились рядом и коммитились в репозиторий. <a href="http://blog.blzr.me/2012/04/technorapture-and-readers.html">Двух</a> <a href="http://blog.blzr.me/2012/06/better-builds-with-maven.html">книг</a> оказалось достаточно, чтобы понять как низко мы пали. После этого мир изменился и уже никогда не будет прежним, а непортируемая сборка, которую нельзя запустить из консоли без IDE, будет восприниматься как нечто, о чем лучше забыть и не вспоминать.<br /><br />Мы успешно выпилили все старые артефакты и всё бы ничего, но наш репозиторий перевалил за гиг и клонирование занимало какое-то совсем неприличное время. Посему, между возможностью собрать любую старую версию (на тот момент мы еще не стабилизировали версии) и маленьким репозиторием, мы выбрали последний вариант. Похерив все хэши, мы удалили все бинарники сократив размер репозитория в 7 раз до 150 мегабайт. Все стало просто летать.<br /><h3 style="text-align: left;">Хирургическое вмешательство </h3><h4 style="text-align: left;">1 Этап. Определение кандидатов на отстрел</h4>Такие файлы должны удовлетворять двум простым правилам:<br /><ul style="text-align: left;"><li>это должен быть бинарный файл</li><li>он должен быть удален на момент поиска</li></ul>Бинарный файл можно опредлить по расширению и отсутствию изменений в этом файле.<br /><h4 style="text-align: left;">2. Этап. Составление расстрельного списка</h4>Используем <a href="http://hgbook.red-bean.com/read/customizing-the-output-of-mercurial.html">стиль</a> для вывода списка файлов:<br /><br /><pre>#Для списка измененных<br />#changeset = "{file_mods}"<br />#Для списка удаленных<br />changeset = "{file_dels}"<br /><br />file_mod  = "{file_mod}\n"<br />file_del  = "{file_del}\n"<br /></pre><br />Дальше составляем два списка командами <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hg log --style style_del | sort -u</span> и <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hg log --style style_mod | sort -u</span>. В первом приближении нам нужно из списка удаленных исключить все элменты которые встречаются в списке измененных. Вычесть файлы можно <a href="http://stackoverflow.com/questions/1370996/minus-operation-on-two-files-using-linux-commands">несколькими</a> способами. Дальше вычитаем при помощи <a href="http://www.linuxjournal.com/article/2156">пайпов</a>:<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">comm -2 -3 \</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&lt;(hg log --style ~/path/to/style_del | sort -u) \</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&lt;(hg log --style ~/path/to/style_mod | sort -u)</span>.<br />Для экспериментов можно передавать диапазон ревизий <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-r 0:100</span> чтобы оптимизировать время.<br /><br />Полученный список нужно будет просмотреть глазами и составить список расширений для удаления. Список расширений можно посмотреть прогнав через <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">| grep -oE "\.\w*$" | sort -u</span>. В нашем случае он получился таким: <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">deb, gz, jar, mp3, so, wav</span>.<br /><br />Прогоняем через <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">sed</span>, выводя только файлы, совпавшие по расширению, формируя <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">filemap</span> для <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hg convert</span>. Итоговая строка фильтрации выглядит так:<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">comm -2 -3 \<br />&lt;(hg log --style ~/path/to/style_del | sort -u) \</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&lt;(hg log --style ~/path/to/style_mod | sort -u) \</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">| sed -n 's/\(.*\)\(deb\|gz\|jar\|mp3\|so\|wav\)/exclude "&amp;"/p' \</span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&gt; filemap</span><br /><h4 style="text-align: left;">3 Этап. Зачистка </h4><div style="text-align: left;">Получившийся filemap скармливаем в <span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><a href="http://mercurial.selenic.com/wiki/ConvertExtension">hg convert</a> --filemap ~/path/to/filemap ~/repo ~/repo_clean</span>. На выходе получаем переродившийся репозиторий без шлака и мусора.</div><h3 style="text-align: left;">Дисклеймер</h3><div style="text-align: left;">Здесь описана операция, успешно проведенная нами год назад. За это вресмя ни разу не понадобилось доступиться к удаленным файлам. На данный момент при 5к коммитах, репозиторий занимает 500Мб. При этом часть бинарных ресурсов всё еще жива и используется.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Фильтрация идет в основном средствами линуксовых команд. Хотя mercurial предоставляет прекрасный <a href="http://mercurial.selenic.com/wiki/MercurialApi">API</a> для доступа к репозиториям, которым сам же и пользуется, на котором можно было бы написать понятную фильтрацию без подобных майндфаков: <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/\(.*\)\(</span> и приседания с ключами команд, на тот момент с этим API я был незнаком, а сейчас просто воспроизвожу свои записки для сохранения в назидание потомкам.</div></div>