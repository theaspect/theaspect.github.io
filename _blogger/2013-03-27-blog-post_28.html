---
layout: post
title: Не ванильное тестирование
date: '2013-03-28T00:10:00.002+07:00'
author: Constantine Linnick
tags:
- боль
- тестирование
- development
modified_time: '2014-04-10T15:47:19.674+07:00'
thumbnail: http://1.bp.blogspot.com/-iBCckzEifk8/UVMfZ_sIMDI/AAAAAAAABxU/XVigojvEdTQ/s72-c/%D0%A0%D0%B8%D1%81%D1%83%D0%BD%D0%BE%D0%BA+%D0%B1%D0%B5%D0%B7+%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F.png
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-5262297323942332475
blogger_orig_url: http://blog.blzr.me/2013/03/blog-post_28.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: right;"><i>... демонстрация выгоды какой-либо технологии на реальном примере <br />всегда затруднена из-за объема сопровождающих сведений, а если проблему редуцировать <br />до ее ядра, то она сама собой исчезает и кажется что огород вообще не стоит усилий.</i></div><div style="text-align: right;"><i>by </i><i><a class="l" href="http://forum.ixbt.com/topic.cgi?id=26:42127#14"><b>mike_teplitsky</b></a> </i></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-iBCckzEifk8/UVMfZ_sIMDI/AAAAAAAABxU/XVigojvEdTQ/s1600/%D0%A0%D0%B8%D1%81%D1%83%D0%BD%D0%BE%D0%BA+%D0%B1%D0%B5%D0%B7+%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://1.bp.blogspot.com/-iBCckzEifk8/UVMfZ_sIMDI/AAAAAAAABxU/XVigojvEdTQ/s1600/%D0%A0%D0%B8%D1%81%D1%83%D0%BD%D0%BE%D0%BA+%D0%B1%D0%B5%D0%B7+%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F.png" height="302" width="320" /></a></div>Продолжение <a href="http://blog.blzr.me/2013/03/blog-post_26.html">поста</a> о неванильном тестировании. Полный текст примеров: исходный <a href="https://bitbucket.org/theaspect/sandbox/src/default/src/main/java/com/blazer/scenario?at=default">код</a>, тестовый <a href="https://bitbucket.org/theaspect/sandbox/src/default/src/test/java/com/blazer/scenario?at=default">фреймворк</a>, тестовый <a href="https://bitbucket.org/theaspect/sandbox/src/default/src/test/resources/com/blazer/scenario?at=default">сценарий</a>. Данный пример повторяет реальную архитектуру, имеется мешанина с логикой, хотя там и написан полный бред. Плюс работа с базой лишь обозначена, а в тесте замокана для удобства. Тест написан только один, просто чтобы продемонстрировать подход - остальные тесты один-в-один.<br /><br /><a name='more'></a><br /><br /><h3 style="text-align: left;">Workflow</h3><h4 style="text-align: left;">1. CollectorDaemon</h4><div style="text-align: left;">На первом этапе FreeSWITCH шлет сырые события, внешне представляющие собой мультимап, хотя ни разу не встречалось более одного значения в ключе, видимо добавили на всякий случай.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">Демоны <a href="https://bitbucket.org/theaspect/sandbox/src/default/src/main/java/com/blazer/scenario/call/CallCollectorDaemon.java?at=default">CallCollectorDaemon</a> и ConferenceCollectorDaemon (заглушка с логикой идентичной CCD) подписываются каждый на свою группу событий, после чего события начинают приходить в метод onEvent.</div><div style="text-align: left;"><pre class="brush:java">&nbsp;&nbsp;&nbsp;&nbsp; public CallCollectorDaemon(CallRouter router) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.router = router;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; subscribe("CREATE", "BRIDGE", "DESTROY");<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; @Override<br />&nbsp;&nbsp;&nbsp; public void onEvent(HashMap&lt;String, String&gt; rawEvent) {<br />&nbsp; &nbsp; ...<br /></pre><br />Задача демона, распарсить события в соответствующие DTO.<br /><h4 style="text-align: left;">2. Router</h4><a href="https://bitbucket.org/theaspect/sandbox/src/default/src/main/java/com/blazer/scenario/call/CallRouter.java?at=default">Router</a> хранит справочник всех ведущихся сессий, создает новые сессии, сливает разние сессии в одну, если они оказываются связанными. После того как подходящая сессия найдена, событие отправляется в сессию для извлечения данных.<br /><br /><h4 style="text-align: left;">3. Call</h4><a href="https://bitbucket.org/theaspect/sandbox/src/default/src/main/java/com/blazer/scenario/call/Call.java?at=default">Call</a> - сессия, которая может породить в процессе несколько записей. При каждом поступившем событии данные извлекаются и проверяются два условия: на готовность записи и завершенность сессии.<br /><br /><h4 style="text-align: left;">4-6. Router</h4>Если в сессии после события оказывается готовая запись, то она извлекается роутером и заполняется данными из базы <br /><pre class="brush:java">private void testCallReady(Call call) {<br />        // Check for ready record<br />        if (call.getReady().size() &gt; 0) {<br />            ready.addAll(call.getReady());<br />            call.getReady().clear();<br />        }<br />        ...<br />    }<br /><br /> <br /><br />... <br /><br />public Record pullRecord(UserDao userDao) {<br />        Record record = ready.pollFirst();<br />        ...<br /><br />        User user = userDao.findUserByName(record.getNumber());<br />        if (user == null) {<br />            user = userDao.findUserByTerminal(record.getNumber());<br />        }<br /><br />        if (user != null) {<br />            record.setUser(user);<br />        }<br /><br />        return record;<br />    }<br /></pre><h4 style="text-align: left;">7. CollectorDaemon</h4><div style="text-align: left;">Демон окончательно сохраняет готовые записи в базу, он же управляет соединением с базой.</div><h3 style="text-align: left;">Тестовый фреймворк</h3><h4 style="text-align: left;">Тестер</h4><div style="text-align: left;"><a href="https://bitbucket.org/theaspect/sandbox/src/default/src/test/java/com/blazer/scenario/RecordTest.java?at=default">Тестер</a> работает только со вторым слоем, потому, что тестировать первый нет особого смысла. Сначала загружается и парсится yaml файл при помощи snakeyaml:</div><div style="text-align: left;"><br /></div><pre class="brush:java">    protected List&lt;Object&gt; loadEvents(String yaml) {<br />        InputStream is = getClass().getClassLoader().getResourceAsStream(yaml);<br />        return (List&lt;Object&gt;) new Yaml().load(is);<br />    }<br /></pre><div style="text-align: left;"><br /></div><div style="text-align: left;">Затем объекты засылаются в роутер если это событие, либо сравниваются с готовыми записями, если это запись:</div><pre class="brush:java">    protected void testEventFlow(List&lt;Object&gt; events) {<br />        HashMap&lt;Long, User&gt; userHashMap = new HashMap&lt;Long, User&gt;();<br />        for (User u : userDao.findAll()) {<br />            userHashMap.put(u.getId(), u);<br />        }<br /><br />        CallRouter er = new CallRouter();<br />        for (Object event : events) {<br />            if (event instanceof CreateEvent) {<br />                er.addEvent((CreateEvent) event);<br />            } else if (event instanceof BridgeEvent) {<br />                er.addEvent((BridgeEvent) event);<br />            } else if (event instanceof DestroyEvent) {<br />                er.addEvent((DestroyEvent) event);<br />            } else if (event instanceof Record) {<br />                Record record = er.pullRecord(userDao);<br />                ((Record) event).setUser(userHashMap.get(((Record) event).getUser().getId()));<br />                compare((Record) event, record);<br />            }<br />        }<br />        assertFalse(er.hasNewRecord());<br />    }<br /></pre><div style="text-align: left;">Для удобства сравнения, поле юзер подменяется по первичному ключу. </div><h4 style="text-align: left;">Сценарий</h4><div style="text-align: left;">Представляет собой <a href="https://bitbucket.org/theaspect/sandbox/src/default/src/test/resources/com/blazer/scenario/SimpleCall.yaml?at=default">типичный</a> yaml файл:</div><div style="text-align: left;"><br /></div><pre class="brush:java">- !!com.blazer.scenario.event.DestroyEvent<br />    id: 541852<br />    chain: 1239641<br />    date: 1333291427000000<br />    service: USER<br />    name: terminal2<br />    hangup: !!com.blazer.scenario.domain.HangupType NORMAL<br /><br />- !!com.blazer.scenario.domain.Record<br />    id: 541852<br />    chain: 1239641<br />    begin: 1333291338000000<br />    end: 1333291427000000<br />    user: !!com.blazer.scenario.domain.User<br />        id: 2<br />    number: terminal2<br />    legB: 541852<br />    hangup: !!com.blazer.scenario.domain.HangupType NORMAL</pre><div style="text-align: left;"><br /></div><div style="text-align: left;">Очень хрупкий, но, тем не менее довольно легко представляющий необходимый объект с любым уровнем иерархии, и даже циклическими ссылками.</div><h3 style="text-align: left;">Проблемные места</h3><div style="text-align: left;"><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; margin-left: 1em; text-align: right;"><tbody><tr><td style="text-align: center;"><a href="http://thejoysofcode.com/post/46173781318/when-we-have-to-simulate-the-software-to-test-it" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" src="http://24.media.tumblr.com/dabf524e57ac679ec83d9d1f61912908/tumblr_mgw3wmVj8j1rk30kxo1_400.gif" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">When we have to simulate the software to test it</td></tr></tbody></table>Клубки логики сосредоточены в трех местах: в роутере на входе (отправка события в нужную сессию) и выходе (заполнение данными) и сессии (пополнение данных и генерация готовых записей). Сам тестовый фреймворк почти не претерпел изменений с эволюцией кода, в отличии от yaml-сценариев. Есть опасение что реальный данные, посылаемые от FreeSWITCH могут со временем разойтись с тестовыми сценариями: тесты будут проходить, но на реальной системе будет мешанина.</div></div></div>