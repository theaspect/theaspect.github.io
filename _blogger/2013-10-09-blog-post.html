---
layout: post
title: Безысходность черного ящика
date: '2013-10-09T05:41:00.002+07:00'
author: Constantine Linnick
tags:
- боль
- open source
- работа
- development
modified_time: '2014-04-10T15:47:19.660+07:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-4417727029710495046
blogger_orig_url: http://blog.blzr.me/2013/10/blog-post.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div class="separator" style="clear: both; text-align: center;"><a href="http://fc06.deviantart.net/fs70/f/2012/245/2/b/not_rocket_science_by_bj_o23-d5ddhgv.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="320" src="http://fc06.deviantart.net/fs70/f/2012/245/2/b/not_rocket_science_by_bj_o23-d5ddhgv.png" width="226" /></a></div>Давно уже ничего не писал, зато, наконец, собрался с силами и заслал пачку пуллреквестов, которые не давли мне покоя последние пол года. Как заапрувят - расскажу подробнее.<br /><h4 style="text-align: left;">Виды систем</h4>Я разделяю два вида черных ящиков (BB). BB первого рода - классическая, закрытая система. ВВ второго рода - настолько сложная система, что даже заглянув внутрь ничего не будет понятно, эдакий корабль пришельцев, функционирующий на технологиях вне нашего понимания (вспоминаются <a href="http://ru.wikipedia.org/wiki/%D0%92%D1%81%D0%B5%D0%BB%D0%B5%D0%BD%D0%BD%D0%B0%D1%8F_%D0%93%D0%B8%D0%BF%D0%B5%D1%80%D0%B8%D0%BE%D0%BD%D0%B0#.D0.A1.D1.84.D0.B5.D1.80.D0.B0_.D1.81.D0.B8.D0.BD.D0.B3.D1.83.D0.BB.D1.8F.D1.80.D0.BD.D0.BE.D1.81.D1.82.D0.B8">подарки</a> Техно-Центра из вселенной Гипериона), с такими системами можно ставить эксперименты, можно сломать, но хотя бы есть надежда понять и разобраться.<br /><br /><a name='more'></a><br /><br />У нас есть необходимость интеграции 1С с нашей системой. Одним из немногих способов двустороннего общения с желтой программой является - COM технология внешних компонент (другая - SOAP, но там все еще хуже). В итоге мы на C# написали прокси, которая через <a href="http://activemq.apache.org/nms/apachenms.html">Apache NMS</a> коннектится к нашей шине, что позволило реиспользовать API. Короче, стек из полудюжины технологий, чтобы позвонить коллеге в соседний кабинет. И только на самом последнем слое, слое 1С я совершенно бессилен и беззащитен.<br /><h4 style="text-align: left;">Нет - Магии</h4><div class="separator" style="clear: both; text-align: center;"><a href="http://img24.imageshack.us/img24/2826/userhw7.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="160" src="http://img24.imageshack.us/img24/2826/userhw7.jpg" width="320" /></a></div>Понимание, что магии нет, дает непередаваемое ощущение прозрачности. Тебе доступен весь стек, начиная от HTTP запроса, до работы ORM (на самом деле не придумал границы, но можно заглянуть абсолютно везде) - любой уровень абстракции. Люди, живущие в мире черных ящиков, воспринимаются как инопланетяне - им даже не приходит в голову, что более сложные технологии построены на более простых. Есть интерфейс, а внутри - происходит таинство. Недавно испытвал это ощущение, когда парсил HTTP запрос, чтобы реализовать перемотку в аудиофайлах, которые мы стримим.<br /><h4 style="text-align: left;">White box</h4><div style="text-align: left;">Возникла, допустим, проблема с ActiveMQ - в сообщениях не шлется метка пользователя. Идем на ASF, качаем исходники, аттачим в IDE (в этот момент ящик становится белым и пушистым), дебажим. И что же мы видим: в процессе сериализации идет работа с джавовым интерфейсом, а конкретное поле появляется в реализации. Сразу становится понятно, как решить эту проблему здесь и сейчас. После этого идем в <a href="http://mail-archives.apache.org/mod_mbox/activemq-dev/201308.mbox/%3CCANonsiSUnTArUC_99WRBrmXLjOm2fTgVqxAzG+u=u1c1-rVWow@mail.gmail.com%3E">мейллист</a> и предлагаем обобщенное решение (хотя, видимо, его никто не читает, но я просто не разбирался с их вокфлоу). Похожая ситуация NMS: нужна тонкая настройка в сериализации объектов - читаешь исходники, смотришь какие используются аннотации, можно даже сделать песочницу и поиграться в ней.</div><h4 style="text-align: left;">Black box</h4>Но, что же происходит, когда мы переходим на уровень 1С? Что-то не так? Ошибка: ошибка. Блядь! Ни логов, ни диагностика, о стектрейсе вообще молчу, Ни-Хе-Ра - because fuck you. Из COM объекта можно прокинуть сообщение, которое даже напишется в лог, но в месте возникновения исключения - <span class="st">Ошибка при вызове метода контекста, все остальное безвозвратно теряется. Конечно, зачем разработчику диагностика. Ему ведь не понадобится отличать неправильно набранный номер от отсутствия у пользователя терминала, с которого он может совершить вызов, а может быть он уже разговаривает по телефону и второй вызов совершать не стоит - Fuck You, Ошибка - Ошибка. И, судя по всему, это никого не парит - ответа на вопрос найти невозможно. Тонюсенькая книжечка, которая стоит денег, но при этом легко гуглится в интернетах - написана на отъебись и оставляет большой простор пытливому разработчику для гипотез и экспериментов. В итоге я сдался и написал метод, который возвращает последнюю возникшую ошибку. Безысходность: понимание BB - 2 зависит исключительно от меня, из стохастичности BB - 1 выхода нет.</span><br /><h4 style="text-align: left;">Идеология открытости</h4>Еще одно интересное явление: прямой диалог. В случае проблемы, ты можешь пойти напрямую к разработчикам, запостить им багрепорт, написать в рассылку разработчиков, потрещать с ними в #IRC. В мире опенсорса это воспринимается как данность. В мире скаченных бесплатно без смс компонентов это просто дикость. Компонент тупит и глючит? Пойти и спросить у разработчика какого хрена? Сделать пуллреквест. Ах да, исходничков-то нет.<br /><br />Хотя и в мире опенсорса есть способы всё <a href="http://blog.clojurewerkz.org/blog/2013/04/20/how-to-make-your-open-source-project-really-awesome/">зафакапить</a>, но это свойственно скорее крупным проектам. Цена ошибки в них настолько высока, что порог вхождения искусственно поднят и нужно <b>реально</b> хотеть заслать им патч, чтобы <a href="http://blog.blzr.me/2012/02/hardest-piece-of-code-i-ever-wrote.html">пробиться</a> через все их бизнес-процессы. Заслать ишью недостаточно - никто не побежит писать тебе код, всем <a href="https://hibernate.atlassian.net/browse/HHH-4140">насрать</a>. Приходится брать и пилить. В маленьких проектах - все гораздо проще. Не нужно предварительно изучать десятистраничную инструкцию (которую еще нужно найти) чтобы заслать патч на три строки. Тем не менее, после n-й итерации становятся понятны общие механизмы (магии нет), где искать и куда писать, даже если на первый взгляд от проекта к проекту процессы сильно отличаются.</div>