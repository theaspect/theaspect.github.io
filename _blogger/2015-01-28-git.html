---
layout: post
title: Редактирование истории в git
date: '2015-01-29T01:33:00.000+06:00'
author: Constantine Linnick
tags:
- работа
- контроль версий
- development
modified_time: '2015-01-29T01:33:01.534+06:00'
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-8937986062905667830
blogger_orig_url: http://blog.blzr.me/2015/01/git.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div class="separator" style="clear: both; text-align: center;"><a href="http://actionbash.com/wp-content/uploads/2013/07/funny-gif-car-jump-over-race.gif" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://actionbash.com/wp-content/uploads/2013/07/funny-gif-car-jump-over-race.gif" height="188" width="320" /></a></div>Этот пост что-то вроде <a href="http://blog.blzr.me/2013/08/advanced-mercurial.html">Advanced mercurial</a>&nbsp;но для git. Рано или поздно все сталкиваются с двумя проблемами: у меня куда-то пропали коммиты и я запушил не туда. Во втором случае есть простой случай, когда никто не успел спулить и когда неправильный кормит у всей команды. Все опасаются применять команды с ключами --hard и --force, но это совсем не страшно, если понимаешь, что все обратимо и ты понимаешь чего хочешь достичь этими командами.<br /><br />Концептуальное отличие от mercurial: в git коммит обязательно должен принадлежать бранчу (без бранча коммит становится detached head), а бранч может быть только один. В mercurial ветки могут быть анонимными, более того может быть несколько веток с одним именем. Чтобы коммит стал виден, должен существовать путь до него из какого-либо бранча. То самое отличие кроны и корневой системы (почему-то именно такая аналогия приходит в голову). В mercurial чтобы коммит был доступен должен существовать путь до него от 0-го коммита, а имена и прочее это мелочи. Соответственно и можно четко проследить начало и конец любой ветви, в отличии от git, где коммиты эфемерные дельты болтающиеся по узлам DAG. Хорошо это или плохо - зависит от, но в централизованной разработке мне больше импонирует mercurial с долгоживущими и вполне материальными ветвями, хотя это не значит что там нельзя редактировать историю - дельта алгебра везде одна. Git же заточен именно под распределенность и множество центральных узлов - помимо ветки foo-branch, обязательно есть origin/foo-branch или another/foo-branch с четким разделением откуда приехал коммит - в mercurial же именование веток сквозное по всем репозиториям, если стянули изменения то они уже ваши и отделить где чьё не получится.<br /><br />Дальше пойдет описание трех сценариев в демке с <a href="https://gist.github.com/theaspect/09d0c0e516d41bfcdb7f">github</a>. Демка пошагово демонстрирует работу Алисы и Боба с общим репозиторием. Запускаем, читаем комментарии, жмем батон. Демка должна работать на unix-like системах где есть bash. Кстати, ознакомьтесь со статьей <a href="http://tonsky.me/blog/reinventing-git-interface/">tonsky</a>&nbsp;- прольет свет на внутренности git.<br /><a name='more'></a><br /><h4 style="text-align: left;">Восстановление коммитов</h4><div>У нас есть несколько коммитов:</div><div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a (HEAD, master) totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 QuickFix. &lt;alice&gt;</span></div></div><div><br /></div><div>Мы их выводим красиво раскрашенными командой с форматированием похожим на <a href="http://git-scm.com/docs/git-log">--oneline</a>, но с добавлением автора:&nbsp;<span style="font-family: Courier New, Courier, monospace;">git log --date-order --pretty=format:%C(yellow)%h%Creset%C(green)%Creset%C(auto)%d%Creset %s %C(magenta)&lt;%an&gt; --decorate --all --graph</span></div><div><br /></div><div>Итак, метка <span style="font-family: Courier New, Courier, monospace;">HEAD</span> и бранч <span style="font-family: Courier New, Courier, monospace;">master</span> на последнем коммите, более поздние сверху. Мы дропаем первые два коммита <span style="font-family: Courier New, Courier, monospace;">git reset --hard HEAD^^</span> и история ожидаемо выглядит</div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 (HEAD, master) QuickFix. &lt;alice&gt;</span></div><div><br /></div><div>Вопрос: где всё? В ref-log вестимо, чтобы отобразить полную историю сначала собираем все коммиты в список, и затем выводим в лог: <span style="font-family: Courier New, Courier, monospace;">git log --date-order --pretty=format:%C(yellow)%h%Creset%C(green)%Creset%C(auto)%d%Creset %s %C(magenta)&lt;%an&gt; --decorate --all --graph $(git rev-list --reflog --all)</span> на демке список будет автоматически раскрыт. Итак, в истории у нас два верхних коммита не принадлежат никакому бранчу и в простом логе недоступны.</div><div><br /></div><div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 (HEAD, master) QuickFix. &lt;alice&gt;</span></div></div><div><br /></div><div>Чтобы их вернуть, есть много способов, сам git предлагает создать бранч и смерджить с master:&nbsp;</div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">git checkout -b lost_commits</span></div><div><span style="font-family: Courier New, Courier, monospace;">git checkout master</span></div><div><span style="font-family: Courier New, Courier, monospace;">git merge lost_commits</span></div><div><span style="font-family: Courier New, Courier, monospace;">git branch -d lost_commits</span></div><div><br /></div><div>История теперь выглядит так:</div><div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">* 4aa9db9 (HEAD, master, lost_commits) Herpderp, shoulda check if it does really compile. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 QuickFix. &lt;alice&gt;</span></div></div><h4 style="text-align: left;">Отмена коммита в удаленном репозитории</h4><div>Простой случай, когда никто не успел стянуть и накоммитить поверх, либо вы пушите в свою ветку с которой никто не работает. В этом случае <span style="font-family: Courier New, Courier, monospace;">push --force</span> совершенно безопасен.</div><div><br /></div><div>История Алисы выглядит так</div><div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">* 1f97ef0 (HEAD, origin/master, master) Nitpicking... &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 4aa9db9 Herpderp, shoulda check if it does really compile. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 QuickFix. &lt;alice&gt;</span></div></div><div><br /></div><div>Алиса хочет удалить верхний коммит, который она уже запушила (<span style="font-family: Courier New, Courier, monospace;">origin/master</span>).</div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">git reset HEAD^ --hard</span></div><div><span style="font-family: Courier New, Courier, monospace;">git push origin --force</span></div><div><br /></div><div>Вуаля, история теперь выглядит так</div><div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">* 4aa9db9 (HEAD, origin/master, master) Herpderp... &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 QuickFix. &lt;alice&gt;</span></div></div><div><br /></div><div>Если кто-то успел стянуть вашу ветку, а потом она случайно переехала на другой коммит, то при пуле git ругнется, мол бранчи указывают совсем ну туда куда ожидалось, спокойно исправит ссылки на новые и продолжит работу как ни в чем не бывало.</div><h4 style="text-align: left;">Сложный случай редактирования истории</h4><div>Алиса запушила изменения, Боб запушил свои изменения поверх и нужно избавиться от одного из старых коммитов.</div><div><div><span style="font-family: Courier New, Courier, monospace;">* 623c081 (HEAD, origin/master, master) Fixing Sarah's bugs. &lt;bob&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 5facd35 small is a real HTML tag, who knew. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 0bb2195 and so the crazy refactoring process sees the sunlight after some months in the dark! &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 4aa9db9 Herpderp, shoulda check if it does really compile. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 QuickFix. &lt;alice&gt;</span></div></div><div><br /></div><div>Алиса хочет избавиться от своего коммита&nbsp;<span style="font-family: 'Courier New', Courier, monospace;">5facd35</span>&nbsp;от который в <span style="font-family: Courier New, Courier, monospace;">origin</span> и, очевидно, у Боба потому, что он успел закоммитить и запушить свои изменения. Используем интерактивный <span style="font-family: Courier New, Courier, monospace;">rebase</span>&nbsp;и закомментируем <span style="font-family: Courier New, Courier, monospace;">pick&nbsp;5facd35</span>&nbsp;чтобы он не попал в новую историю.</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">git rebase -i HEAD^^</span></div><div><br /></div><div>В редакторе испавим и сохраним</div><div><br /></div><div><div><span style="font-family: Courier New, Courier, monospace;">#pick 5facd35 small is a real HTML tag, who knew.</span></div><div><span style="font-family: Courier New, Courier, monospace;">pick 623c081 Fixing Sarah's bugs.</span></div></div><div><br /></div><div>Если возникнут конфликты, то исправляем их, коммитим и продолжаем rebase</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">git add -A</span></div><div><span style="font-family: Courier New, Courier, monospace;">git commit -m Fixing Sarah's bugs.</span></div><div><span style="font-family: Courier New, Courier, monospace;">git rebase --continue</span></div><div><br /></div><div>История теперь выглядит расщепленной</div><div><br /></div><div><div><span style="font-family: Courier New, Courier, monospace;">* 678e268 (HEAD, master)&nbsp;Fixing Sarah's bugs.&nbsp;&lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">| * 623c081 (origin/master) Fixing Sarah's bugs. &lt;bob&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">| * 5facd35 small is a real HTML tag, who knew. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">|/</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 0bb2195 and so the crazy refactoring process sees the sunlight after some months in the dark! &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 4aa9db9 Herpderp, shoulda check if it does really compile. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 QuickFix. &lt;alice&gt;</span></div></div><div><br /></div><div>Мы делаем <span style="font-family: Courier New, Courier, monospace;">git push origin --force</span> и переходим к Бобу, он видит следующее</div><div><br /></div><div><div><span style="font-family: Courier New, Courier, monospace;">* 678e268 (origin/master)&nbsp;Fixing Sarah's bugs.&nbsp;&lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">| * 9c446c9 (HEAD, master) Ok, 5am, it works. &nbsp;For real. &lt;bob&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">| * 623c081 Fixing Sarah's bugs. &lt;bob&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">| * 5facd35 small is a real HTML tag, who knew. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">|/</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 0bb2195 and so the crazy refactoring process sees the sunlight after some months in the dark! &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 4aa9db9 Herpderp, shoulda check if it does really compile. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 QuickFix. &lt;alice&gt;</span></div></div><div><br /></div><div>Он успел сделать коммит но не успел запушить. Обыконовенного <span style="font-family: Courier New, Courier, monospace;">git pull origin </span>хватит чтобы его единственный коммит переехал на <span style="font-family: Courier New, Courier, monospace;">origin/master</span>, даже конфликтов не будет.</div><div><br /></div><div><div><span style="font-family: Courier New, Courier, monospace;">* b741ec5 (HEAD, master) Ok, 5am, it works. &nbsp;For real. &lt;bob&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 678e268 (origin/master)&nbsp;Fixing Sarah's bugs.&nbsp;&lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 0bb2195 and so the crazy refactoring process sees the sunlight after some months in the dark! &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 4aa9db9 Herpderp, shoulda check if it does really compile. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 QuickFix. &lt;alice&gt;</span></div></div><div><br /></div><div>Проверим ref-log и убедимся, что ничего не пропало&nbsp;<span style="font-family: 'Courier New', Courier, monospace;">git log --date-order --pretty=format:%C(yellow)%h%Creset%C(green)%Creset%C(auto)%d%Creset %s %C(magenta)&lt;%an&gt; --decorate --all --graph $(git rev-list --reflog --all)&nbsp;</span>на самом деле все коммиты на месте, хоть и не видны потому что нет бранча, их спокойно можно воскресить, дав имя</div><div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">* b741ec5 (HEAD, master) Ok, 5am, it works. &nbsp;For real. &lt;bob&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 678e268 (origin/master)&nbsp;Fixing Sarah's bugs.&nbsp;&lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">| * 9c446c9 Ok, 5am, it works. &nbsp;For real. &lt;bob&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">| * 623c081 Fixing Sarah's bugs. &lt;bob&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">| * 5facd35 small is a real HTML tag, who knew. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">|/</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 0bb2195 and so the crazy refactoring process sees the sunlight after some months in the dark! &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 4aa9db9 Herpderp, shoulda check if it does really compile. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* c39e99a totally more readable &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* 3fb6f50 should work now. &lt;alice&gt;</span></div><div><span style="font-family: Courier New, Courier, monospace;">* fe1e8a8 QuickFix. &lt;alice&gt;</span></div></div><h4 style="text-align: left;">Итоги</h4><div>История не пропадает, редактировать и пушить в общий репозиторий не опасно, главное предупреждать, чтобы не возникало войны альтернативных историй.</div></div>