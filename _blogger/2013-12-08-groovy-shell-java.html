---
layout: post
title: Groovy shell в веб-приложении Java
date: '2013-12-08T19:00:00.000+07:00'
author: Constantine Linnick
tags:
- работа
- orm
- development
modified_time: '2014-04-10T15:47:19.671+07:00'
thumbnail: http://1.bp.blogspot.com/-g3bnjK6Ymr4/UqRdyRZsR3I/AAAAAAAACLg/SweB7VxTznw/s72-c/Demo.png
blogger_id: tag:blogger.com,1999:blog-372595778394672936.post-4980446329130291634
blogger_orig_url: http://blog.blzr.me/2013/12/groovy-shell-java.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><h4 style="text-align: left;">Доступ к доменной модели</h4>При разработке иногда часто хочется иметь под рукой доменную модель со всеми сервисами и доступом к актуальной базе, чтобы можно было нагенерить нужных данных и положить их в базу, замерить производительность выборок, простестировать работоспособность отдельного куска кода. Это особенно удобно, если контейнер долго запускается. Впервые я это увидел в Django: <a href="https://docs.djangoproject.com/en/1.6/ref/django-admin/#dbshell">dbshell</a>, что весьма удобно. Мы имитировали этот шелл, положив запускабельный класс в папку с тестами, который инициализировал доменную модель и необходимый набор сервисов.<br /><h4 style="text-align: left;">POC веб-консоли</h4>Но хочется большего. В серверных приложения за время работы может накопиться невоспроизводимое состояние, либо в целом приложение начинает вести себя неадекватно. Основной способ борьбы - выводить подробные логи, а потом вдумчиво курить стектрейсы, строя гипотезы, как исключение могло возникнуть. А потом перезапустить приложение. Но что если доступаться к живому приложению? Возможности по съему телеметрии стали бы неограниченными: нам доступно для чтения и изменения все состояние живого приложения (правда неосторожными действиями можно его легко убить).<br /><br /><a name='more'></a><br /><br />Groovy гордится своей встраиваемостью, синтаксис совместим с джавой, есть готовый <a href="http://zeroturnaround.com/rebellabs/scripting-your-java-application-with-groovy/">шелл</a>. В общем я нашел <a href="http://naleid.com/blog/2013/10/17/embedding-a-groovy-web-console-in-a-java-spring-app">репост</a> <a href="http://groovy.codehaus.org/Embedding+a+Groovy+Console+in+a+Java+Server+Application">репоста</a> репоста (оригинал протух). Главным недостатком была завязанность на Spring, а хотелось Guice. Оставалось дело за малым.<br /><br />Все исходники лежат в <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/repl/?at=default">песочнице</a>. Запускабельный <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/repl/EmbeddedServer.java?at=default">EmbeddedServer</a> заполняет нехитрую доменную модель из двух сущностей тестовыми данными и поднимает <a href="https://wiki.eclipse.org/Jetty/Tutorial/Embedding_Jetty">embedded Jetty</a> сервер. За DI отвечает <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/repl/servlet/GuiceListener.java?at=default">GuiceListener</a>, который рулит маппингом и инъектит EntityManager-ами. За выполнение скриптов отвечает <a href="http://hg.blzr.me/sandbox/src/default/src/main/java/com/blazer/repl/service/GroovyService.java?at=default">GroovyService</a> из которого я выкинул всё, что относилось к Spring. HTML страница с шеллом находится в <a href="http://hg.blzr.me/sandbox/src/default/src/main/resources/com/blazer/repl/index.html?at=default">index.html</a>.<br /><br /><h4 style="text-align: left;">Как работает?</h4><a href="http://1.bp.blogspot.com/-g3bnjK6Ymr4/UqRdyRZsR3I/AAAAAAAACLg/SweB7VxTznw/s1600/Demo.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="640" src="http://1.bp.blogspot.com/-g3bnjK6Ymr4/UqRdyRZsR3I/AAAAAAAACLg/SweB7VxTznw/s640/Demo.png" width="502" /></a>1.Жмем Refresh и получаем исходные данные.<br />2. В TextArea вводим скрипт<br />3. Жмем Evar<br />4. Снизу получаем результат выполнения<br />5. Если нажать Refresh еще раз, то увидим новую строку.<br /><br />В скрипте доступны дву переменные: log для вывода в лог сервера и emp - Guice провайдер для EntityManager.<br /><br />Скрипты выполняются довольно быстро. Можно даже попробовать сделать что-то вроде реальной консоли с сохранением состояния в сессии, но зачем заморачиваться.</div>